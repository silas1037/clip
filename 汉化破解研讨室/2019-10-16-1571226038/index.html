
  <!DOCTYPE html>
  <html id="" class="">
    <!-- OriginalSrc: https://www.iteye.com/blog/rednaxelafx-658308 -->
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />

      <title>BattleMoonWars 归档解压/压缩程序（砍掉重炼版） - Script Ahead, Code Behind - ITeye博客</title>
      
<link rel="shortcut icon" href="assets/1571226038-1cd7c6fd0de855e9efac8dbe4a274b55.ico" type="image/x-icon" referrerpolicy="no-referrer">


<link href="assets/1571226038-86dfe308f444f6e1aa00f6b28e8b2407.css" media="screen" rel="stylesheet" type="text/css" referrerpolicy="no-referrer">
<link href="assets/1571226038-771d0182f7eae18f5989664d94717b86.css" media="screen" rel="stylesheet" type="text/css" referrerpolicy="no-referrer">
<link href="assets/1571226038-396dd74c56d84598b8a22d8cb10eaf3a.css" media="screen" rel="stylesheet" type="text/css" referrerpolicy="no-referrer">
<link rel="stylesheet" type="text/css" href="assets/1571226038-9aeb703993455cc093fff678a2ad3401.css" referrerpolicy="no-referrer">
<link rel="stylesheet" type="text/css" href="assets/1571226038-05fb66a2c1140728ea8d74162a702c22.css" referrerpolicy="no-referrer">


<style class="darkreader darkreader--fallback" media="screen"></style>
<style class="darkreader darkreader--text" media="screen"></style>
<style class="darkreader darkreader--invert" media="screen"></style>
<style class="darkreader darkreader--inline" media="screen">[data-darkreader-inline-bgcolor] {
  background-color: var(--darkreader-inline-bgcolor) !important;
}
[data-darkreader-inline-bgimage] {
  background-image: var(--darkreader-inline-bgimage) !important;
}
[data-darkreader-inline-border] {
  border-color: var(--darkreader-inline-border) !important;
}
[data-darkreader-inline-border-bottom] {
  border-bottom-color: var(--darkreader-inline-border-bottom) !important;
}
[data-darkreader-inline-border-left] {
  border-left-color: var(--darkreader-inline-border-left) !important;
}
[data-darkreader-inline-border-right] {
  border-right-color: var(--darkreader-inline-border-right) !important;
}
[data-darkreader-inline-border-top] {
  border-top-color: var(--darkreader-inline-border-top) !important;
}
[data-darkreader-inline-boxshadow] {
  box-shadow: var(--darkreader-inline-boxshadow) !important;
}
[data-darkreader-inline-color] {
  color: var(--darkreader-inline-color) !important;
}
[data-darkreader-inline-fill] {
  fill: var(--darkreader-inline-fill) !important;
}
[data-darkreader-inline-stroke] {
  stroke: var(--darkreader-inline-stroke) !important;
}
[data-darkreader-inline-outline] {
  outline-color: var(--darkreader-inline-outline) !important;
}</style>
<style class="darkreader darkreader--user-agent" media="screen">html {
    background-color: #191a1b !important;
}
html, body, input, textarea, select, button {
    background-color: #191a1b;
}
html, body, input, textarea, select, button {
    border-color: #5a5956;
    color: #f0ebe2;
}
a {
    color: #4791e7;
}
table {
    border-color: #4f4e4c;
}
::placeholder {
    color: #bfb9ac;
}
::selection {
    background-color: #125cb4;
    color: #fffffd;
}
::-moz-selection {
    background-color: #125cb4;
    color: #fffffd;
}
input:-webkit-autofill,
textarea:-webkit-autofill,
select:-webkit-autofill {
    background-color: #565a0f !important;
    color: #f0ebe2 !important;
}
::-webkit-scrollbar {
    background-color: #1d1f1f;
    color: #cbc5b9;
}
::-webkit-scrollbar-thumb {
    background-color: #2c2d2d;
}
::-webkit-scrollbar-thumb:hover {
    background-color: #343636;
}
::-webkit-scrollbar-thumb:active {
    background-color: #404142;
}
::-webkit-scrollbar-corner {
    background-color: #191a1b;
}
* {
    scrollbar-color: #2c2d2d #1d1f1f;
}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--override" media="screen">.jfk-bubble {
    background-color: #000000 !important;
}
.vimvixen-hint {
    background-color: #765500 !important;
    border-color: #d5b22e !important;
    color: #f9edcc !important;
}</style>
<style>
 
.hide-main-content{
    position: relative;
}
.hide-article-box {
    display: none;
    position: absolute;
    z-index: 9999;
    bottom: -1px;
    width: 100%;
    padding-top: 160px;
    background-image: -webkit-gradient(linear,left top, left bottom,from(rgba(255,255,255,0)),color-stop(70%, #fff));
    background-image: linear-gradient(-180deg,rgba(255,255,255,0) 0%,#fff 70%);
}
.hide-article-box #btn-readmore{
    color: #ca0c16;
    border: 1px solid #ca0c16;
    margin: 10px auto;
    padding: 0 8px;
    display: block;
    font-size: 14px;
    border-radius: 4px;
    text-align: center;
    background-color: transparent;
    height: 34px;
    width: 74px;
    line-height: 32px;
    min-width: 72px;
    cursor: pointer;
}
.hide-article-box #btn-readmore:hover{
    background: #ca0c16;
    color:#fff;
    text-decoration: none;
}
</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">.dp-rb .symbol { color: #a70; }.dp-rb .variable { color: #a70; font-weight: bold; }</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">.dp-rb .symbol { color: #a70; }.dp-rb .variable { color: #a70; font-weight: bold; }</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">.dp-cpp .datatypes { color: #2E8B57; font-weight: bold; }</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">.dp-cpp .datatypes { color: #2E8B57; font-weight: bold; }</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--cors" media="screen">body,dd,div,dl,dt,form,h1,h2,h3,h4,h5,h6,html,input,li,ol,p,select,td,textarea,th,ul{margin:0;padding:0}*{box-sizing:border-box}body,html{min-height:100%}h1,h2,h3,h4,h5,h6{font-weight:400}.recommend-right ul,ol{list-style:none}.recommend-right img{border:none;vertical-align:middle}.recommend-right a{text-decoration:none;color:#232323}.recommend-right table{border-collapse:collapse;table-layout:fixed}.recommend-right input,textarea{outline:0;border:none}.recommend-right textarea{resize:none;overflow:auto}.clearfix:after{content:" ";display:block;height:0;visibility:hidden;clear:both}.recommend{overflow:hidden}.newbox.recommend{overflow:hidden}svg.icon{width:1em;height:1em;vertical-align:-.15em;fill:currentColor;overflow:hidden;margin-right:4px}svg.icon.icon-level{width:3em;height:1em}.recommend-right{float:right;width:300px;margin-left:8px;background-color:#fff;-webkit-box-shadow:0 2px 4px 0 rgba(0,0,0,.05);box-shadow:0 2px 4px 0 rgba(0,0,0,.05)}.recommend-right .recommend-fixed-box{background-color:#fff}.recommend-right .right-item{padding:8px 0;overflow:hidden;word-break:break-all;margin-left:8px;margin-right:8px;border-bottom:1px solid #f5f5f5;box-sizing:border-box}.recommend-right .right-item:hover .content h5{color:#ca0c16}.recommend-right .right-item .content{margin-bottom:4px}.recommend-right .right-item .content img{width:58px;height:36px}.recommend-right .right-item .content h5{display:inline;font-size:14px;color:#5c5c5c;letter-spacing:0;line-height:20px;max-height:44px;overflow:hidden;font-weight:500;margin-right:4px;white-space:nowrap;text-overflow:ellipsis}.recommend-right .right-item .content .h5width{width:76%;margin-left:8px}.recommend-right .right-item .content span{margin-right:8px;font-size:12px;color:#999;letter-spacing:0;line-height:20px}.recommend-right .right-item .content .download_mark{border:1px solid #e3e3e3;padding:2px;margin-right:4px}.recommend-right .right-item .right-item-desc{font-size:12px;color:#999;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style class="darkreader darkreader--cors" media="screen">.{font-family:""!important;font-size:16px;font-style:normal;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.fanyi:before{content:"\e661"}.shouji:before{content:"\e66f"}.yuedushu:before{content:"\e682"}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style type="text/css">@keyframes fadeInOpacity{0%{opacity:0}to{opacity:1}}:hover>*>.fbvd--wrapper{animation-name:fadeInOpacity;animation-duration:.3s;opacity:1}.fbvd--wrapper{position:absolute;top:10px;left:10px;opacity:0;text-align:center;margin:0;z-index:5}.fbvd--wrapper a{background: url("") no-repeat 3px 4.55px; background-color: #fff; display:inline-block;font:700 14px Helvetica,Arial,sans-serif;color:#4b4f56;text-decoration:none;vertical-align:middle;padding:0px 8px 0px;margin-right:8px;border-radius:2px; line-height: 22px; padding-left:19px; border: 1px solid #e7e7e7; background-size: 13px}.fbvd--wrapper a:last-child{margin-right:0}.fbvd--wrapper a:hover{text-decoration:none}.fbvd--wrapper a:focus{box-shadow:0 0 1px 2px rgba(88,144,255,.75),0 1px 1px rgba(0,0,0,.15);outline:none}.fbvd--wrapper b{font-size:13px;position:relative;top:1px;color:#3b5998;font-weight:400}</style>
<style class="darkreader darkreader--sync" media="screen"></style>
<style>
  .userinfo {display: none !important;}
  .persion_article h3{
    background: none !important;
    border-bottom: none!important;
    padding: 0!important;
    margin-bottom: 0!important;
    line-height: 1!important;
  }
  .persion_article .right_box{
    margin-top: 0!important;
  }
  .persion_article .footer_box .feed_new_tit span{
    padding-left: 0!important;
  }
</style>
<style class="darkreader darkreader--sync" media="screen"></style>

      <style class="mx-wc-style">
        .mx-wc-main img {max-width: 100%;}
        .mx-wc-main{
          box-sizing: content-box;
          background-color: rgb(35, 36, 36) !important;
          margin: 0 auto;
          margin-top: 20px;
          max-width: 706px;
        }
        @media (min-width: 768px) {
          .mx-wc-main { padding: 15px 15px 80px 15px }
        }
        @media (max-width: 767px) {
          .mx-wc-main { padding: 15px 3px 80px 3px }
        }
  
      </style>
    </head>
    <body style="background-color: #464646 !important; min-height: 100%; height: auto; position: static !important; overflow: auto !important; padding-bottom: 0px !important;" id="" class="">
      <div class="mx-wc-main">
        <DIV id="page" style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><DIV id="content" class="clearfix" style="display: block !important;float: none !important;position: relative !important;top: 0 !important;left: 0 !important;border: 0px !important;width: 100% !important;min-width: 100% !important;max-width: 100% !important;height: auto !important;min-height: auto !important;max-height: 100% !important;margin: 0px !important;padding: 0px !important;"><div id="main" class="mx-wc-selected-elem mx-wc-1571226038" style="display: block; float: none !important; position: relative !important; top: 0px !important; left: 0px !important; margin: 0px !important; flex: unset !important; width: 100% !important; max-width: 100% !important;">
        



        





<div class="blog_main">
  
  <div class="blog_title">
    <h3>
      BattleMoonWars 归档解压/压缩程序（砍掉重炼版）
      <em class="actions">      </em>
    </h3>
    <ul class="blog_categories"><strong>博客分类：</strong> <li><a href="https://www.iteye.com/category/24338" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">Reverse Engineering</a></li> </ul>
        <div class="news_tag"><a href="http://www.iteye.com/blogs/tag/Ruby" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">Ruby</a><a href="http://www.iteye.com/blogs/tag/C%23" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">C#</a><a href="http://www.iteye.com/blogs/tag/C++" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">C++</a><a href="http://www.iteye.com/blogs/tag/C" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">C</a><a href="http://www.iteye.com/blogs/tag/EXT" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">EXT</a>&nbsp;</div>
  </div>

  <div id="blog_content" class="hide-main-content">
    
    以前写过<a target="_blank" href="http://rednaxelafx.iteye.com/blog/180521" referrerpolicy="no-referrer" rel="noopener noreferrer">BattleMoonWars的归档处理程序</a>。可惜在JavaEye上的老帖里的代码真的非常老了；那代码我后来改过几次的，修掉以前偷懒不支持多层目录的问题，还修过对应LZSS解压的问题（但一直偷懒没实现压缩……用Java来写LZSS压缩真痛苦）。
<br>改过的版本老早就不知道哪儿去了。茶茶也找不到那代码了，但要发新的BMW完全版的汉化补丁又等着用这打包工具……拖到今天终于重新写了个。
<br>
<br>以前那个是用Java写的，这次用Ruby来试试。目标是用干净的代码实现归档处理程序需要的解包和打包功能，外带应用上LZSS的压缩。
<br>写完之后，拿代码跟以前的Java版比较了一下，觉得自己貌似没啥长进。眯着眼睛看的话会觉得俩版本都差不多，至少“算法”都一样——这么小的东西根本没用上啥算法嘛orz
<br>不过以前那版代码要想整理得干净一些的话显然是有许多办法的。印象中后来也没这么乱了，但，找不到了啊 T T
<br>诶，用Java这么重量级的语言去实现这么简单的小工具本身就是个杯具。要是当年我就熟悉什么脚本语言的话……
<br>
<br>Ruby的代码还是比Java的显著的少了。我倒没特意要为了短而写短，反而有些地方还特意用了比较长的名字和有点冗余的运算，因为懒得写注释，代码本身就应该能体现意图。
<br>代码能减少的一个原因在于Java的标准I/O API用起来不方便，而且默认用big endian，在我们这little endian的平台上用起来很是费事。就为了各种转换endian、在byte[]与别的数据类型间转换之类的地方就写了很多垃圾代码。
<br>相比之下Ruby的I/O API用起来非常方便，而且靠强大的String#unpack与Array#pack就已经可以解决很多转换问题，所以读取索引项的代码Ruby版比Java版短很多。
<br>另外，Java代码的“噪音”还是比较大。嵌套的a.setXxx(b.getXxx())这类代码自然比不上a.xxx = b.xxx来得清爽。
<br>
<br>OK，又到大段贴代码时间。贴代码比放附件“安全”多了，回头Google Reader把这篇备份到了之后我就不怕代码丢失了 ha ha ha
<br>这次用的Ruby版本是去年7月自己用VC9来build的1.9.2dev。
<br><div class="quote_title">引用</div><div class="quote_div">ruby 1.9.2dev (2009-07-22 trunk 24241) [i386-mswin32_90]</div>
<br>
<br><span style="color: red; --darkreader-inline-color:#e63f3c;" data-darkreader-inline-color="">在GBK编码的系统上打开文件时，可能要注意用String#force_encoding('gbk')强制将ASCII-8BIT编码的文件名转换一下。</span>
<br>
<br>bmw_archiver.rb
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Ruby代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=%23!..%2Fruby19%2Fbin%2Fruby%0A%23%20coding%3A%20binary%0A%0Arequire%20'fileutils'%0Arequire%20File.join(File.expand_path(File.dirname(__FILE__))%2C%20'compress%2Flzss.so')%0Ainclude%20FileUtils%0A%0Amodule%20BMWArchiver%0A%20%20class%20Archive%0A%20%20%20%20BENIFIT_THRESHOLD%20%3D%2020%0A%20%20%20%20%0A%20%20%20%20SIGNATURE%20%3D%20'yanepkDx'%0A%20%20%20%20attr_accessor%20%3Aarc_path%2C%20%3Adir_path%2C%20%3Aentry_count%0A%20%20%20%20attr_reader%20%20%20%3Aindex%0A%20%20%20%20%0A%20%20%20%20class%20IndexEntry%0A%20%20%20%20%20%20LENGTH%20%3D%20256%20%2B%204%20*%203%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20attr_accessor%20%3Afile_path%2C%20%3Aoffset%0A%20%20%20%20%20%20attr_accessor%20%3Aoriginal_length%2C%20%3Acompressed_length%0A%20%20%20%20%20%20attr_writer%20%20%20%3Acompressed%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20def%20initialize(file_path%2C%20offset%2C%20original_length%2C%20compressed_length)%0A%20%20%20%20%20%20%20%20%40file_path%2C%20%40offset%2C%20%40original_length%2C%20%40compressed_length%20%3D%0A%20%20%20%20%20%20%20%20%20%20file_path%2C%20offset%2C%20original_length%2C%20compressed_length%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%40compressed%20%3D%20original_length%20%3E%20compressed_length%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20def%20compressed%3F%0A%20%20%20%20%20%20%20%20%40compressed%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20def%20should_compress%3F%0A%20%20%20%20%20%20%20%20%5B'.yga'%2C%20'.ogg'%5D.none%3F%20%7B%7Cext%7C%20%40file_path.downcase.end_with%3F%20ext%20%7D%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20def%20self.from_binary(str)%0A%20%20%20%20%20%20%20%20IndexEntry.new(*(str.unpack%20'Z256III'))%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20def%20to_binary%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%40file_path%2C%20%40offset%2C%0A%20%20%20%20%20%20%20%20%20%20%40original_length%2C%20%40compressed_length%0A%20%20%20%20%20%20%20%20%5D.pack('Z256III')%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20def%20to_s%0A%20%20%20%20%20%20%20%20%3C%3C-ENTRY_STR%0AIndexEntry%20%7B%0A%20%20file_path%3A%20%20%20%20%20%20%20%20%20%23%40file_path%0A%20%20offset%3A%20%20%20%20%20%20%20%20%20%20%20%200x%23%7B%40offset.to_s%2016%7D%0A%20%20compression%3A%20%20%20%20%20%20%20%23%7Bself.compressed%3F%20%3F%20'LZSS'%20%3A%20'none'%7D%0A%20%20original_length%3A%20%20%20%23%40original_length%0A%20%20compressed_length%3A%20%23%40compressed_length%0A%7D%0A%20%20%20%20%20%20%20%20ENTRY_STR%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20def%20add_index_entry(entry)%0A%20%20%20%20%20%20%40index%20%7C%7C%3D%20%5B%5D%0A%20%20%20%20%20%20%40index%20%3C%3C%20entry%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20def%20extract_to(dest_dir_path)%0A%20%20%20%20%20%20%40dir_path%20%3D%20dest_dir_path%0A%20%20%20%20%20%20File.open(%40arc_path%2C%20'rb')%20do%20%7Carc_file%7C%0A%20%20%20%20%20%20%20%20%40index.each%20do%20%7Centry%7C%0A%20%20%20%20%20%20%20%20%20%20arc_file.pos%20%3D%20entry.offset%0A%20%20%20%20%20%20%20%20%20%20contents%20%3D%20arc_file.read(entry.compressed_length)%0A%20%20%20%20%20%20%20%20%20%20if%20entry.compressed%3F%0A%20%20%20%20%20%20%20%20%20%20%20%20contents%20%3D%20Compress%3A%3ALZSS%3A%3Adecode(contents%2C%20entry.original_length)%0A%20%20%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20%20%20dest_file_path%20%3D%20File.join(dest_dir_path%2C%20entry.file_path)%0A%20%20%20%20%20%20%20%20%20%20mkdir_p%20File.dirname%20dest_file_path%0A%20%20%20%20%20%20%20%20%20%20File.open(dest_file_path%2C%20'wb')%20do%20%7Cdest_file%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20dest_file%20%3C%3C%20contents%0A%20%20%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20def%20save_to(dest_arc_path)%0A%20%20%20%20%20%20%40arc_path%20%3D%20dest_arc_path%0A%20%20%20%20%20%20File.open(%40arc_path%2C%20'wb')%20do%20%7Carc_file%7C%0A%20%20%20%20%20%20%20%20%23%20write%20signature%20and%20entry%20count%0A%20%20%20%20%20%20%20%20arc_file%20%3C%3C%20SIGNATURE%20%3C%3C%20%5B%40entry_count%5D.pack('I')%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%23%20write%20contents%20first%2C%20and%20calculate%20offset%0A%20%20%20%20%20%20%20%20index_section_start%20%3D%20SIGNATURE.bytesize%20%2B%204%0A%20%20%20%20%20%20%20%20index_length%20%20%20%20%20%20%20%20%3D%20IndexEntry%3A%3ALENGTH%20*%20%40entry_count%0A%20%20%20%20%20%20%20%20data_section_start%20%20%3D%20index_section_start%20%2B%20index_length%0A%20%20%20%20%20%20%20%20current_offset%20%20%20%20%20%20%3D%20data_section_start%0A%20%20%20%20%20%20%20%20arc_file.pos%20%20%20%20%20%20%20%20%3D%20current_offset%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%40index.each%20do%20%7Centry%7C%0A%20%20%20%20%20%20%20%20%20%20entry.offset%20%3D%20current_offset%0A%20%20%20%20%20%20%20%20%20%20contents%20%3D%20File.binread%20File.join(%40dir_path%2C%20entry.file_path)%0A%20%20%20%20%20%20%20%20%20%20if%20entry.should_compress%3F%0A%20%20%20%20%20%20%20%20%20%20%20%20compressed_contents%20%3D%20Compress%3A%3ALZSS%3A%3Aencode(contents)%0A%20%20%20%20%20%20%20%20%20%20%20%20compressed_length%20%20%20%3D%20compressed_contents.bytesize%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20only%20use%20compressed%20version%20when%20it's%20benificial%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20compressed_length%20%2B%20BENIFIT_THRESHOLD%20%3C%20entry.original_length%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20contents%20%3D%20compressed_contents%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20entry.compressed_length%20%3D%20compressed_length%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20entry.compressed%20%3D%20true%0A%20%20%20%20%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20%20%20arc_file%20%3C%3C%20contents%0A%20%20%20%20%20%20%20%20%20%20current_offset%20%2B%3D%20entry.compressed_length%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%23%20write%20index%0A%20%20%20%20%20%20%20%20arc_file.pos%20%3D%20index_section_start%0A%20%20%20%20%20%20%20%20%40index.each%20do%20%7Centry%7C%0A%20%20%20%20%20%20%20%20%20%20arc_file%20%3C%3C%20entry.to_binary%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20def%20to_s%0A%20%20%20%20%20%20%3C%3C-ARCHIVE_STR%0ABMW%20Archive%20file%3A%20%23%40arc_path%0ANo.%20of%20entries%3A%20%23%40entry_count%0AEntries%3A%0A%23%7B%40index.map%7B%7Ce%7C%20e.to_s%7D.join%7D%0A%20%20%20%20%20%20ARCHIVE_STR%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20class%20%3C%3C%20self%0A%20%20%20%20%20%20%23%20builds%20an%20Archive%20object%20with%20index%20initialized%20from%20specified%20file%0A%20%20%20%20%20%20def%20from_archive(path)%0A%20%20%20%20%20%20%20%20File.open(path%2C%20'rb')%20do%20%7Carc_file%7C%0A%20%20%20%20%20%20%20%20%20%20verify_signature_of%20arc_file%0A%20%20%20%20%20%20%20%20%20%20self.new.tap%20do%20%7Carc%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20arc.arc_path%20%20%20%20%3D%20path%0A%20%20%20%20%20%20%20%20%20%20%20%20arc.entry_count%20%3D%20read_int32_from%20arc_file%0A%20%20%20%20%20%20%20%20%20%20%20%20arc.entry_count.times%20do%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20arc.add_index_entry(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20IndexEntry.from_binary(arc_file.read(IndexEntry%3A%3ALENGTH)))%0A%20%20%20%20%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20def%20build_from_dir(src_dir_path)%0A%20%20%20%20%20%20%20%20verify_src_dir%20src_dir_path%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20self.new.tap%20do%20%7Carc%7C%0A%20%20%20%20%20%20%20%20%20%20arc.dir_path%20%3D%20src_dir_path%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%23%20HACK%3A%20for%20the%20ease%20of%20using%20Dir.glob%0A%20%20%20%20%20%20%20%20%20%20old_pwd%20%3D%20Dir.pwd%0A%20%20%20%20%20%20%20%20%20%20cd%20src_dir_path%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20Dir.glob('**%2F*').each%20do%20%7Cpath%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20next%20if%20Dir.exists%3F%20path%20%20%23%20skip%20directories%0A%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20file_length%20%3D%20File.size%20path%0A%20%20%20%20%20%20%20%20%20%20%20%20arc.add_index_entry%20IndexEntry.new(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20path.gsub('%2F'%2C%20'%5C%5C')%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20-1%2C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20offset%20not%20calculated%20yet%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20file_length%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20file_length)%0A%20%20%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20arc.entry_count%20%3D%20arc.index.size%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20cd%20old_pwd%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20private%0A%20%20%20%20%20%20def%20verify_signature_of(file)%0A%20%20%20%20%20%20%20%20raise%20'Wrong%20signature'%20unless%20file.read(8)%20%3D%3D%20SIGNATURE%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20def%20verify_src_dir(dir_path)%0A%20%20%20%20%20%20%20%20unless%20Dir.exists%3F%20dir_path%0A%20%20%20%20%20%20%20%20%20%20raise%20%22The%20specified%20source%20directory%20doesn't%20exist%3A%20%23%7Bdir_path%7D%22%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20def%20read_int32_from(file)%0A%20%20%20%20%20%20%20%20file.read(4).unpack('I').first%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A%0A%0Aif%20__FILE__%20%3D%3D%20%240%0A%20%20include%20BMWArchiver%0A%20%20opt%2C%20arc_path%2C%20dir_path%20%3D%20ARGV%0A%20%20case%20opt%0A%20%20when%20'e'%0A%20%20%20%20arc%20%3D%20Archive.from_archive%20arc_path%0A%20%20%20%20arc.extract_to%20dir_path%0A%20%20%20%20puts%20arc%0A%20%20when%20'a'%0A%20%20%20%20arc%20%3D%20Archive.build_from_dir%20dir_path%0A%20%20%20%20arc.save_to%20arc_path%0A%20%20%20%20puts%20arc%0A%20%20else%0A%20%20%20%20puts%20%3C%3C-USAGE_STR%0AUsage%3A%20bmw_archiver%20opt%20arc_file%20dir_path%0Aoptions%3A%0A%20%20e%20-%20extract%20arc_file%20to%20dir_path%0A%20%20a%20-%20pack%20dir_path%20into%20arc_file%0A%20%20%20%20USAGE_STR%0A%20%20end%0A%20%20puts%20'done'%0Aend" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer"><img class="star" src="assets/1571226038-bf632ec55a05f69a9359f73417402b26.png" alt="收藏代码"><img class="spinner" src="assets/1571226038-a42df3a5b569bdc98ca473a4a3adfeac.gif" style="display:none"></a></div></div><ol start="1" class="dp-rb"><li><span><span class="comment">#!../ruby19/bin/ruby</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="comment">#&nbsp;coding:&nbsp;binary</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>require&nbsp;<span class="string">'fileutils'</span><span>&nbsp;&nbsp;</span></span></li><li><span>require&nbsp;<span class="builtin">File</span><span>.join(</span><span class="builtin">File</span><span>.expand_path(</span><span class="builtin">File</span><span>.dirname(__FILE__)),&nbsp;</span><span class="string">'compress/lzss.so'</span><span>)&nbsp;&nbsp;</span></span></li><li><span>include&nbsp;FileUtils&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="keyword">module</span><span>&nbsp;BMWArchiver&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;<span class="keyword">class</span><span>&nbsp;Archive&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;BENIFIT_THRESHOLD&nbsp;=&nbsp;20&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;SIGNATURE&nbsp;=&nbsp;<span class="string">'yanepkDx'</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;attr_accessor&nbsp;<span class="symbol">:arc_path</span><span>,&nbsp;</span><span class="symbol">:dir_path</span><span>,&nbsp;</span><span class="symbol">:entry_count</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;attr_reader&nbsp;&nbsp;&nbsp;<span class="symbol">:index</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">class</span><span>&nbsp;IndexEntry&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LENGTH&nbsp;=&nbsp;256&nbsp;+&nbsp;4&nbsp;*&nbsp;3&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attr_accessor&nbsp;<span class="symbol">:file_path</span><span>,&nbsp;</span><span class="symbol">:offset</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attr_accessor&nbsp;<span class="symbol">:original_length</span><span>,&nbsp;</span><span class="symbol">:compressed_length</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attr_writer&nbsp;&nbsp;&nbsp;<span class="symbol">:compressed</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;initialize(file_path,&nbsp;offset,&nbsp;original_length,&nbsp;compressed_length)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@file_path</span><span>,&nbsp;</span><span class="variable">@offset</span><span>,&nbsp;</span><span class="variable">@original_length</span><span>,&nbsp;</span><span class="variable">@compressed_length</span><span>&nbsp;=&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_path,&nbsp;offset,&nbsp;original_length,&nbsp;compressed_length&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@compressed</span><span>&nbsp;=&nbsp;original_length&nbsp;&gt;&nbsp;compressed_length&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;compressed?&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@compressed</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;should_compress?&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="string">'.yga'</span><span>,&nbsp;</span><span class="string">'.ogg'</span><span>].none?&nbsp;{|ext|&nbsp;</span><span class="variable">@file_path</span><span>.downcase.end_with?&nbsp;ext&nbsp;}&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;</span><span class="keyword">self</span><span>.from_binary(str)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IndexEntry.<span class="keyword">new</span><span>(*(str.unpack&nbsp;</span><span class="string">'Z256III'</span><span>))&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;to_binary&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@file_path</span><span>,&nbsp;</span><span class="variable">@offset</span><span>,&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@original_length</span><span>,&nbsp;</span><span class="variable">@compressed_length</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;].pack(<span class="string">'Z256III'</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;to_s&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;-ENTRY_STR&nbsp;&nbsp;</span></li><li><span>IndexEntry&nbsp;{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;file_path:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">#@file_path</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;offset:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x<span class="comment">#{@offset.to_s&nbsp;16}</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;compression:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">#{self.compressed?&nbsp;?&nbsp;'LZSS'&nbsp;:&nbsp;'none'}</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;original_length:&nbsp;&nbsp;&nbsp;<span class="comment">#@original_length</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;compressed_length:&nbsp;<span class="comment">#@compressed_length</span><span>&nbsp;&nbsp;</span></span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENTRY_STR&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;add_index_entry(entry)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@index</span><span>&nbsp;||=&nbsp;[]&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@index</span><span>&nbsp;&lt;&lt;&nbsp;entry&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;extract_to(dest_dir_path)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@dir_path</span><span>&nbsp;=&nbsp;dest_dir_path&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtin">File</span><span>.open(</span><span class="variable">@arc_path</span><span>,&nbsp;</span><span class="string">'rb'</span><span>)&nbsp;</span><span class="keyword">do</span><span>&nbsp;|arc_file|&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@index</span><span>.</span><span class="keyword">each</span><span>&nbsp;</span><span class="keyword">do</span><span>&nbsp;|entry|&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc_file.pos&nbsp;=&nbsp;entry.offset&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contents&nbsp;=&nbsp;arc_file.read(entry.compressed_length)&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;entry.compressed?&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contents&nbsp;=&nbsp;Compress::LZSS:<span class="symbol">:decode</span><span>(contents,&nbsp;entry.original_length)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dest_file_path&nbsp;=&nbsp;<span class="builtin">File</span><span>.join(dest_dir_path,&nbsp;entry.file_path)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mkdir_p&nbsp;<span class="builtin">File</span><span>.dirname&nbsp;dest_file_path&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtin">File</span><span>.open(dest_file_path,&nbsp;</span><span class="string">'wb'</span><span>)&nbsp;</span><span class="keyword">do</span><span>&nbsp;|dest_file|&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dest_file&nbsp;&lt;&lt;&nbsp;contents&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;save_to(dest_arc_path)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@arc_path</span><span>&nbsp;=&nbsp;dest_arc_path&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtin">File</span><span>.open(</span><span class="variable">@arc_path</span><span>,&nbsp;</span><span class="string">'wb'</span><span>)&nbsp;</span><span class="keyword">do</span><span>&nbsp;|arc_file|&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">#&nbsp;write&nbsp;signature&nbsp;and&nbsp;entry&nbsp;count</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc_file&nbsp;&lt;&lt;&nbsp;SIGNATURE&nbsp;&lt;&lt;&nbsp;[<span class="variable">@entry_count</span><span>].pack(</span><span class="string">'I'</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">#&nbsp;write&nbsp;contents&nbsp;first,&nbsp;and&nbsp;calculate&nbsp;offset</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index_section_start&nbsp;=&nbsp;SIGNATURE.bytesize&nbsp;+&nbsp;4&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index_length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;IndexEntry::LENGTH&nbsp;*&nbsp;<span class="variable">@entry_count</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data_section_start&nbsp;&nbsp;=&nbsp;index_section_start&nbsp;+&nbsp;index_length&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_offset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;data_section_start&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc_file.pos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;current_offset&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@index</span><span>.</span><span class="keyword">each</span><span>&nbsp;</span><span class="keyword">do</span><span>&nbsp;|entry|&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry.offset&nbsp;=&nbsp;current_offset&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contents&nbsp;=&nbsp;<span class="builtin">File</span><span>.binread&nbsp;</span><span class="builtin">File</span><span>.join(</span><span class="variable">@dir_path</span><span>,&nbsp;entry.file_path)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;entry.should_compress?&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compressed_contents&nbsp;=&nbsp;Compress::LZSS:<span class="symbol">:encode</span><span>(contents)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compressed_length&nbsp;&nbsp;&nbsp;=&nbsp;compressed_contents.bytesize&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">#&nbsp;only&nbsp;use&nbsp;compressed&nbsp;version&nbsp;when&nbsp;it's&nbsp;benificial</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;compressed_length&nbsp;+&nbsp;BENIFIT_THRESHOLD&nbsp;&lt;&nbsp;entry.original_length&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contents&nbsp;=&nbsp;compressed_contents&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry.compressed_length&nbsp;=&nbsp;compressed_length&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entry.compressed&nbsp;=&nbsp;<span class="keyword">true</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc_file&nbsp;&lt;&lt;&nbsp;contents&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;current_offset&nbsp;+=&nbsp;entry.compressed_length&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">#&nbsp;write&nbsp;index</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc_file.pos&nbsp;=&nbsp;index_section_start&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@index</span><span>.</span><span class="keyword">each</span><span>&nbsp;</span><span class="keyword">do</span><span>&nbsp;|entry|&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc_file&nbsp;&lt;&lt;&nbsp;entry.to_binary&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;to_s&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;&lt;-ARCHIVE_STR&nbsp;&nbsp;</span></li><li><span>BMW&nbsp;Archive&nbsp;file:&nbsp;<span class="comment">#@arc_path</span><span>&nbsp;&nbsp;</span></span></li><li><span>No.&nbsp;of&nbsp;entries:&nbsp;<span class="comment">#@entry_count</span><span>&nbsp;&nbsp;</span></span></li><li><span>Entries:&nbsp;&nbsp;</span></li><li><span><span class="comment">#{@index.map{|e|&nbsp;e.to_s}.join}</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ARCHIVE_STR&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">class</span><span>&nbsp;&lt;&lt;&nbsp;</span><span class="keyword">self</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">#&nbsp;builds&nbsp;an&nbsp;Archive&nbsp;object&nbsp;with&nbsp;index&nbsp;initialized&nbsp;from&nbsp;specified&nbsp;file</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;from_archive(path)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtin">File</span><span>.open(path,&nbsp;</span><span class="string">'rb'</span><span>)&nbsp;</span><span class="keyword">do</span><span>&nbsp;|arc_file|&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify_signature_of&nbsp;arc_file&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">self</span><span>.</span><span class="keyword">new</span><span>.tap&nbsp;</span><span class="keyword">do</span><span>&nbsp;|arc|&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc.arc_path&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;path&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc.entry_count&nbsp;=&nbsp;read_int32_from&nbsp;arc_file&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc.entry_count.times&nbsp;<span class="keyword">do</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc.add_index_entry(&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IndexEntry.from_binary(arc_file.read(IndexEntry::LENGTH)))&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;build_from_dir(src_dir_path)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify_src_dir&nbsp;src_dir_path&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">self</span><span>.</span><span class="keyword">new</span><span>.tap&nbsp;</span><span class="keyword">do</span><span>&nbsp;|arc|&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc.dir_path&nbsp;=&nbsp;src_dir_path&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">#&nbsp;HACK:&nbsp;for&nbsp;the&nbsp;ease&nbsp;of&nbsp;using&nbsp;Dir.glob</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old_pwd&nbsp;=&nbsp;<span class="builtin">Dir</span><span>.pwd&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cd&nbsp;src_dir_path&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtin">Dir</span><span>.glob(</span><span class="string">'**/*'</span><span>).</span><span class="keyword">each</span><span>&nbsp;</span><span class="keyword">do</span><span>&nbsp;|path|&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">next</span><span>&nbsp;</span><span class="keyword">if</span><span>&nbsp;</span><span class="builtin">Dir</span><span>.exists?&nbsp;path&nbsp;&nbsp;</span><span class="comment">#&nbsp;skip&nbsp;directories</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_length&nbsp;=&nbsp;<span class="builtin">File</span><span>.size&nbsp;path&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc.add_index_entry&nbsp;IndexEntry.<span class="keyword">new</span><span>(&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path.gsub(<span class="string">'/'</span><span>,&nbsp;</span><span class="string">'\\'</span><span>),&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">#&nbsp;offset&nbsp;not&nbsp;calculated&nbsp;yet</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_length,&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_length)&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arc.entry_count&nbsp;=&nbsp;arc.index.size&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cd&nbsp;old_pwd&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;verify_signature_of(file)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">raise</span><span>&nbsp;</span><span class="string">'Wrong&nbsp;signature'</span><span>&nbsp;</span><span class="keyword">unless</span><span>&nbsp;file.read(8)&nbsp;==&nbsp;SIGNATURE&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;verify_src_dir(dir_path)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">unless</span><span>&nbsp;</span><span class="builtin">Dir</span><span>.exists?&nbsp;dir_path&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">raise</span><span>&nbsp;</span><span class="string">"The&nbsp;specified&nbsp;source&nbsp;directory&nbsp;doesn't&nbsp;exist:&nbsp;#{dir_path}"</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">def</span><span>&nbsp;read_int32_from(file)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file.read(4).unpack(<span class="string">'I'</span><span>).first&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="keyword">if</span><span>&nbsp;__FILE__&nbsp;==&nbsp;</span><span class="variable">$0</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;include&nbsp;BMWArchiver&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;opt,&nbsp;arc_path,&nbsp;dir_path&nbsp;=&nbsp;ARGV&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;<span class="keyword">case</span><span>&nbsp;opt&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;<span class="keyword">when</span><span>&nbsp;</span><span class="string">'e'</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;arc&nbsp;=&nbsp;Archive.from_archive&nbsp;arc_path&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;arc.extract_to&nbsp;dir_path&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;puts&nbsp;arc&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;<span class="keyword">when</span><span>&nbsp;</span><span class="string">'a'</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;arc&nbsp;=&nbsp;Archive.build_from_dir&nbsp;dir_path&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;arc.save_to&nbsp;arc_path&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;puts&nbsp;arc&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;puts&nbsp;&lt;&lt;-USAGE_STR&nbsp;&nbsp;</span></li><li><span>Usage:&nbsp;bmw_archiver&nbsp;opt&nbsp;arc_file&nbsp;dir_path&nbsp;&nbsp;</span></li><li><span>options:&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;e&nbsp;-&nbsp;extract&nbsp;arc_file&nbsp;to&nbsp;dir_path&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;a&nbsp;-&nbsp;pack&nbsp;dir_path&nbsp;into&nbsp;arc_file&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;USAGE_STR&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;puts&nbsp;<span class="string">'done'</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li></ol></div>
<br>
<br>上面就是这归档处理程序的主要代码了。
<br>这次多得有<a target="_blank" href="http://night-stalker.iteye.com/" referrerpolicy="no-referrer" rel="noopener noreferrer">night_stalker</a>同学的大力支持，帮忙在一个现成的经典LZSS实现上包了层Ruby扩展。下面是完整代码。
<br>
<br>他已经把这个包装版发成一个gem了，地址是<a target="_blank" href="http://rubygems.org/gems/lzss" referrerpolicy="no-referrer" rel="noopener noreferrer">http://rubygems.org/gems/lzss</a>。安装此gem需要一个C编译器，GCC、VC之类都可以。
<br>
<br>extconf.rb
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">Ruby代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=require%20%22mkmf%22%0A%0Acreate_makefile%20'lzss'" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer"><img class="star" src="assets/1571226038-bf632ec55a05f69a9359f73417402b26.png" alt="收藏代码"><img class="spinner" src="assets/1571226038-a42df3a5b569bdc98ca473a4a3adfeac.gif" style="display:none"></a></div></div><ol start="1" class="dp-rb"><li><span><span>require&nbsp;</span><span class="string">"mkmf"</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>create_makefile&nbsp;<span class="string">'lzss'</span><span>&nbsp;&nbsp;</span></span></li></ol></div>
<br>
<br>把实际实现注册给Ruby用：
<br>
<br>lzss-ext.c
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">C代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=%23include%20%3Cruby.h%3E%0A%0Asize_t%20Encode(size_t%20ilen%2C%20char*%20istr%2C%20size_t%20olen%2C%20char*%20ostr)%3B%0Avoid%20Decode(size_t%20ilen%2C%20unsigned%20char*%20istr%2C%20size_t%20olen%2C%20char*%20ostr)%3B%0A%0Astatic%20VALUE%20encode(VALUE%20self%2C%20VALUE%20str)%20%7B%0A%09size_t%20ilen%20%3D%20RSTRING_LEN(str)%3B%0A%09char*%20buff%20%3D%20(char*)malloc(ilen%20*%202)%3B%0A%09size_t%20olen%20%3D%20Encode(RSTRING_LEN(str)%2C%20RSTRING_PTR(str)%2C%20ilen%20*%202%2C%20buff)%3B%0A%09VALUE%20ret%20%3D%20rb_str_new(buff%2C%20olen)%3B%0A%09free(buff)%3B%0A%09return%20ret%3B%0A%7D%0A%0Astatic%20VALUE%20decode(VALUE%20self%2C%20VALUE%20str%2C%20VALUE%20v_olen)%20%7B%0A%09size_t%20ilen%20%3D%20RSTRING_LEN(str)%3B%0A%09VALUE%20ret%20%3D%20rb_str_new(0%2C%20NUM2INT(v_olen))%3B%0A%09Decode(ilen%2C%20RSTRING_PTR(str)%2C%20NUM2INT(v_olen)%2C%20RSTRING_PTR(ret))%3B%0A%09return%20ret%3B%0A%7D%0A%0Avoid%20Init_lzss()%20%7B%0A%09VALUE%20Compress%20%3D%20rb_define_module(%22Compress%22)%3B%0A%09VALUE%20LZSS%20%3D%20rb_define_module_under(Compress%2C%20%22LZSS%22)%3B%0A%09rb_define_module_function(LZSS%2C%20%22encode%22%2C%20RUBY_METHOD_FUNC(encode)%2C%201)%3B%0A%09rb_define_module_function(LZSS%2C%20%22decode%22%2C%20RUBY_METHOD_FUNC(decode)%2C%202)%3B%0A%7D" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer"><img class="star" src="assets/1571226038-bf632ec55a05f69a9359f73417402b26.png" alt="收藏代码"><img class="spinner" src="assets/1571226038-a42df3a5b569bdc98ca473a4a3adfeac.gif" style="display:none"></a></div></div><ol start="1" class="dp-cpp"><li><span><span class="preprocessor">#include&nbsp;&lt;ruby.h&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="datatypes">size_t</span><span>&nbsp;Encode(</span><span class="datatypes">size_t</span><span>&nbsp;ilen,&nbsp;</span><span class="datatypes">char</span><span>*&nbsp;istr,&nbsp;</span><span class="datatypes">size_t</span><span>&nbsp;olen,&nbsp;</span><span class="datatypes">char</span><span>*&nbsp;ostr);&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">void</span><span>&nbsp;Decode(</span><span class="datatypes">size_t</span><span>&nbsp;ilen,&nbsp;unsigned&nbsp;</span><span class="datatypes">char</span><span>*&nbsp;istr,&nbsp;</span><span class="datatypes">size_t</span><span>&nbsp;olen,&nbsp;</span><span class="datatypes">char</span><span>*&nbsp;ostr);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="keyword">static</span><span>&nbsp;VALUE&nbsp;encode(VALUE&nbsp;self,&nbsp;VALUE&nbsp;str)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">size_t</span><span>&nbsp;ilen&nbsp;=&nbsp;RSTRING_LEN(str);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">char</span><span>*&nbsp;buff&nbsp;=&nbsp;(</span><span class="datatypes">char</span><span>*)malloc(ilen&nbsp;*&nbsp;2);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">size_t</span><span>&nbsp;olen&nbsp;=&nbsp;Encode(RSTRING_LEN(str),&nbsp;RSTRING_PTR(str),&nbsp;ilen&nbsp;*&nbsp;2,&nbsp;buff);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;VALUE&nbsp;ret&nbsp;=&nbsp;rb_str_new(buff,&nbsp;olen);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;free(buff);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;ret;&nbsp;&nbsp;</span></span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="keyword">static</span><span>&nbsp;VALUE&nbsp;decode(VALUE&nbsp;self,&nbsp;VALUE&nbsp;str,&nbsp;VALUE&nbsp;v_olen)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">size_t</span><span>&nbsp;ilen&nbsp;=&nbsp;RSTRING_LEN(str);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;VALUE&nbsp;ret&nbsp;=&nbsp;rb_str_new(0,&nbsp;NUM2INT(v_olen));&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;Decode(ilen,&nbsp;RSTRING_PTR(str),&nbsp;NUM2INT(v_olen),&nbsp;RSTRING_PTR(ret));&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;ret;&nbsp;&nbsp;</span></span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="keyword">void</span><span>&nbsp;Init_lzss()&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;VALUE&nbsp;Compress&nbsp;=&nbsp;rb_define_module(<span class="string">"Compress"</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;VALUE&nbsp;LZSS&nbsp;=&nbsp;rb_define_module_under(Compress,&nbsp;<span class="string">"LZSS"</span><span>);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;rb_define_module_function(LZSS,&nbsp;<span class="string">"encode"</span><span>,&nbsp;RUBY_METHOD_FUNC(encode),&nbsp;1);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;rb_define_module_function(LZSS,&nbsp;<span class="string">"decode"</span><span>,&nbsp;RUBY_METHOD_FUNC(decode),&nbsp;2);&nbsp;&nbsp;</span></span></li><li><span>}&nbsp;&nbsp;</span></li></ol></div>
<br>
<br>实际LZSS实现用的是<a target="_blank" href="http://oku.edu.mie-u.ac.jp/~okumura/" referrerpolicy="no-referrer" rel="noopener noreferrer">奥村晴彦</a>教授在80年代末写的版本。日本许多游戏里用的LZSS压缩实现都是从这个版本演化而来的，用起来非常顺手。
<br>稍微修改了几处：
<br>1、原始版本是用空格（0x20）来填充滑动窗口的初始值，这里修改为用0x00填充。由于原本实现主要用于压缩文本，用空格填充是个很合理的选择；这里则可能压缩任意二进制数据，所以选择用0x00填充。
<br>2、把原本直接对FILE的I/O操作改为对unsigned char*的buffer的操作，便于把它当作库来用。
<br>算法本身是完全没有修改的。没尝试去提高压缩速度（解压速度也没啥改善余地了）。其实这个时候还有后续的进化版，但我的首要目标是让这个归档处理程序能压缩出跟那游戏引擎里的工具完全一致的归档，自然就不太关心进一步提升压缩速度或压缩率了 =_=|||
<br>
<br>lzss.c
<br><div class="dp-highlighter" id=""><div class="bar"><div class="tools">C代码 <embed wmode="transparent" src="/javascripts/syntaxhighlighter/clipboard_new.swf" width="14" height="15" flashvars="clipboard=%2F**************************************************************%0A%20%20%20%20LZSS.C%20--%20A%20Data%20Compression%20Program%0A%20%20%20%20(tab%20%3D%204%20spaces)%0A***************************************************************%0A%20%20%20%204%2F6%2F1989%20Haruhiko%20Okumura%0A%20%20%20%20Use%2C%20distribute%2C%20and%20modify%20this%20program%20freely.%0A%20%20%20%20Please%20send%20me%20your%20improved%20versions.%0A%20%20%20%20%20%20%20%20PC-VAN%20%20%20%20%20%20%20%20SCIENCE%0A%20%20%20%20%20%20%20%20NIFTY-Serve%20%20%20%20PAF01022%0A%20%20%20%20%20%20%20%20CompuServe%20%20%20%2074050%2C1022%0A**************************************************************%2F%0A%23include%20%3Cstdlib.h%3E%0A%23include%20%3Cstdio.h%3E%0A%23include%20%3Cstring.h%3E%0A%23include%20%3Cctype.h%3E%0A%0A%23define%20N%20%20%20%20%20%20%20%20%204096%20%20%20%20%2F*%20size%20of%20ring%20buffer%20*%2F%0A%23define%20F%20%20%20%20%20%20%20%20%20%20%2018%20%20%20%20%2F*%20upper%20limit%20for%20match_length%20*%2F%0A%23define%20THRESHOLD%20%20%20%202%20%20%20%20%2F*%20encode%20string%20into%20position%20and%20length%20if%20match_length%20is%20greater%20than%20this%20*%2F%0A%23define%20NIL%20%20%20%20%20%20%20%20%20%20N%20%20%20%20%2F*%20index%20for%20root%20of%20binary%20search%20trees%20*%2F%0A%0A%2F*%20of%20longest%20match.%20%20These%20are%20set%20by%20the%20InsertNode()%20procedure.%20*%2F%0Astatic%20int%20match_position%3B%0Astatic%20int%20match_length%3B%0A%0Astatic%20void%20InsertNode(unsigned%20char*%20text_buf%2C%20int*%20lson%2C%20int*%20rson%2C%20int*%20dad%2C%20int%20r)%0A%20%20%20%20%2F*%20Inserts%20string%20of%20length%20F%2C%20text_buf%5Br..r%2BF-1%5D%2C%20into%20one%20of%20the%0A%20%20%20%20%20%20%20trees%20(text_buf%5Br%5D'th%20tree)%20and%20returns%20the%20longest-match%20position%0A%20%20%20%20%20%20%20and%20length%20via%20the%20global%20variables%20match_position%20and%20match_length.%0A%20%20%20%20%20%20%20If%20match_length%20%3D%20F%2C%20then%20removes%20the%20old%20node%20in%20favor%20of%20the%20new%0A%20%20%20%20%20%20%20one%2C%20because%20the%20old%20one%20will%20be%20deleted%20sooner.%0A%20%20%20%20%20%20%20Note%20r%20plays%20double%20role%2C%20as%20tree%20node%20and%20position%20in%20buffer.%20*%2F%0A%7B%0A%20%20%20%20int%20%20i%2C%20p%2C%20cmp%3B%0A%20%20%20%20unsigned%20char%20%20*key%3B%0A%0A%20%20%20%20cmp%20%3D%201%3B%20%20key%20%3D%20%26text_buf%5Br%5D%3B%20%20p%20%3D%20N%20%2B%201%20%2B%20key%5B0%5D%3B%0A%20%20%20%20rson%5Br%5D%20%3D%20lson%5Br%5D%20%3D%20NIL%3B%20%20match_length%20%3D%200%3B%0A%20%20%20%20for%20(%20%3B%20%3B%20)%20%7B%0A%20%20%20%20%20%20%20%20if%20(cmp%20%3E%3D%200)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(rson%5Bp%5D%20!%3D%20NIL)%20p%20%3D%20rson%5Bp%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20else%20%7B%20%20rson%5Bp%5D%20%3D%20r%3B%20%20dad%5Br%5D%20%3D%20p%3B%20%20return%3B%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(lson%5Bp%5D%20!%3D%20NIL)%20p%20%3D%20lson%5Bp%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20else%20%7B%20%20lson%5Bp%5D%20%3D%20r%3B%20%20dad%5Br%5D%20%3D%20p%3B%20%20return%3B%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20for%20(i%20%3D%201%3B%20i%20%3C%20F%3B%20i%2B%2B)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20((cmp%20%3D%20key%5Bi%5D%20-%20text_buf%5Bp%20%2B%20i%5D)%20!%3D%200)%20%20break%3B%0A%20%20%20%20%20%20%20%20if%20(i%20%3E%20match_length)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20match_position%20%3D%20p%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20((match_length%20%3D%20i)%20%3E%3D%20F)%20%20break%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20dad%5Br%5D%20%3D%20dad%5Bp%5D%3B%20%20lson%5Br%5D%20%3D%20lson%5Bp%5D%3B%20%20rson%5Br%5D%20%3D%20rson%5Bp%5D%3B%0A%20%20%20%20dad%5Blson%5Bp%5D%5D%20%3D%20r%3B%20%20dad%5Brson%5Bp%5D%5D%20%3D%20r%3B%0A%20%20%20%20if%20(rson%5Bdad%5Bp%5D%5D%20%3D%3D%20p)%20rson%5Bdad%5Bp%5D%5D%20%3D%20r%3B%0A%20%20%20%20else%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20lson%5Bdad%5Bp%5D%5D%20%3D%20r%3B%0A%20%20%20%20dad%5Bp%5D%20%3D%20NIL%3B%20%20%2F*%20remove%20p%20*%2F%0A%7D%0A%0Astatic%20void%20DeleteNode(int*%20lson%2C%20int*%20rson%2C%20int*%20dad%2C%20int%20p)%20%20%2F*%20deletes%20node%20p%20from%20tree%20*%2F%0A%7B%0A%20%20%20%20int%20%20q%3B%0A%20%20%20%20%0A%20%20%20%20if%20(dad%5Bp%5D%20%3D%3D%20NIL)%20return%3B%20%20%2F*%20not%20in%20tree%20*%2F%0A%20%20%20%20if%20(rson%5Bp%5D%20%3D%3D%20NIL)%20q%20%3D%20lson%5Bp%5D%3B%0A%20%20%20%20else%20if%20(lson%5Bp%5D%20%3D%3D%20NIL)%20q%20%3D%20rson%5Bp%5D%3B%0A%20%20%20%20else%20%7B%0A%20%20%20%20%20%20%20%20q%20%3D%20lson%5Bp%5D%3B%0A%20%20%20%20%20%20%20%20if%20(rson%5Bq%5D%20!%3D%20NIL)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20do%20%7B%20%20q%20%3D%20rson%5Bq%5D%3B%20%20%7D%20while%20(rson%5Bq%5D%20!%3D%20NIL)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20rson%5Bdad%5Bq%5D%5D%20%3D%20lson%5Bq%5D%3B%20%20dad%5Blson%5Bq%5D%5D%20%3D%20dad%5Bq%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20lson%5Bq%5D%20%3D%20lson%5Bp%5D%3B%20%20dad%5Blson%5Bp%5D%5D%20%3D%20q%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20rson%5Bq%5D%20%3D%20rson%5Bp%5D%3B%20%20dad%5Brson%5Bp%5D%5D%20%3D%20q%3B%0A%20%20%20%20%7D%0A%20%20%20%20dad%5Bq%5D%20%3D%20dad%5Bp%5D%3B%0A%20%20%20%20if%20(rson%5Bdad%5Bp%5D%5D%20%3D%3D%20p)%20rson%5Bdad%5Bp%5D%5D%20%3D%20q%3B%20%20else%20lson%5Bdad%5Bp%5D%5D%20%3D%20q%3B%0A%20%20%20%20dad%5Bp%5D%20%3D%20NIL%3B%0A%7D%0A%0A%23define%20_get(c)%20%5C%0A%09if%20(!%20ilen)%20%7B%5C%0A%09%09c%20%3D%20EOF%3B%5C%0A%09%09break%3B%5C%0A%09%7D%5C%0A%09c%20%3D%20*istr%3B%5C%0A%09%2B%2Bistr%3B%5C%0A%09--ilen%0A%0A%23define%20_put(c)%20%5C%0A%09*ostr%20%3D%20c%3B%5C%0A%09%2B%2Bostr%3B%5C%0A%09--olen%0A%0Asize_t%20Encode(size_t%20ilen%2C%20char*%20istr%2C%20size_t%20olen%2C%20char*%20ostr)%0A%7B%0A%20%20%20%20int%20%20i%2C%20c%2C%20len%2C%20r%2C%20s%2C%20last_match_length%2C%20code_buf_ptr%3B%0A%20%20%20%20unsigned%20char%20%20code_buf%5B17%5D%2C%20mask%3B%0A%09size_t%20codesize%20%3D%200%3B%0A%09int%20lson%5BN%20%2B%201%5D%2C%20rson%5BN%20%2B%20257%5D%2C%20dad%5BN%20%2B%201%5D%3B%20%2F*%20left%20%26%20right%20children%20%26%20parents%20--%20These%20constitute%20binary%20search%20trees.%20*%2F%0A%09unsigned%20char%20text_buf%5BN%20%2B%20F%20-%201%5D%3B%20%20%20%20%20%20%20%20%20%20%2F*%20ring%20buffer%20of%20size%20N%2C%20with%20extra%20F-1%20bytes%20to%20facilitate%20string%20comparison%20*%2F%0A%20%20%0A%20%20match_position%20%3D%200%3B%0A%20%20match_length%20%3D%200%3B%0A%0A%09if%20(ilen%20%3D%3D%200)%20return%200%3B%0A%20%20%20%20%0A%20%20%20%20%2F*%20initialize%20trees%20*%2F%0A%09%2F*%20For%20i%20%3D%200%20to%20N%20-%201%2C%20rson%5Bi%5D%20and%20lson%5Bi%5D%20will%20be%20the%20right%20and%0A%20%20%20%20left%20children%20of%20node%20i.%20%20These%20nodes%20need%20not%20be%20initialized.%0A%20%20%20%20Also%2C%20dad%5Bi%5D%20is%20the%20parent%20of%20node%20i.%20%20These%20are%20initialized%20to%0A%20%20%20%20NIL%20(%3D%20N)%2C%20which%20stands%20for%20'not%20used.'%0A%20%20%20%20For%20i%20%3D%200%20to%20255%2C%20rson%5BN%20%2B%20i%20%2B%201%5D%20is%20the%20root%20of%20the%20tree%0A%20%20%20%20for%20strings%20that%20begin%20with%20character%20i.%20%20These%20are%20initialized%0A%20%20%20%20to%20NIL.%20%20Note%20there%20are%20256%20trees.%20*%2F%0A%20%20%20%20for%20(i%20%3D%20N%20%2B%201%3B%20i%20%3C%3D%20N%20%2B%20256%3B%20i%2B%2B)%20rson%5Bi%5D%20%3D%20NIL%3B%0A%20%20%20%20for%20(i%20%3D%200%3B%20i%20%3C%20N%3B%20i%2B%2B)%20dad%5Bi%5D%20%3D%20NIL%3B%0A%0A%20%20%20%20code_buf%5B0%5D%20%3D%200%3B%20%20%2F*%20code_buf%5B1..16%5D%20saves%20eight%20units%20of%20code%2C%20and%0A%20%20%20%20%20%20%20%20code_buf%5B0%5D%20works%20as%20eight%20flags%2C%20%221%22%20representing%20that%20the%20unit%0A%20%20%20%20%20%20%20%20is%20an%20unencoded%20letter%20(1%20byte)%2C%20%220%22%20a%20position-and-length%20pair%0A%20%20%20%20%20%20%20%20(2%20bytes).%20%20Thus%2C%20eight%20units%20require%20at%20most%2016%20bytes%20of%20code.%20*%2F%0A%20%20%20%20code_buf_ptr%20%3D%20mask%20%3D%201%3B%0A%20%20%20%20s%20%3D%200%3B%20%20r%20%3D%20N%20-%20F%3B%0A%20%20%20%20for%20(i%20%3D%20s%3B%20i%20%3C%20r%3B%20i%2B%2B)%20text_buf%5Bi%5D%20%3D%200%3B%20%20%2F*%20Clear%20the%20buffer%20with%0A%20%20%20%20%20%20%20%20any%20character%20that%20will%20appear%20often.%20*%2F%0A%20%20%20%20for%20(len%20%3D%200%3B%20len%20%3C%20F%20%26%26%20ilen%3B%20len%2B%2B)%20%7B%0A%09%09_get(c)%3B%0A%20%20%20%20%20%20%20%20text_buf%5Br%20%2B%20len%5D%20%3D%20c%3B%0A%09%09%2F*%20Read%20F%20bytes%20into%20the%20last%20F%20bytes%20of%20the%20buffer%20*%2F%0A%09%7D%0A%20%20%20%20for%20(i%20%3D%201%3B%20i%20%3C%3D%20F%3B%20i%2B%2B)%20InsertNode(text_buf%2C%20lson%2C%20rson%2C%20dad%2C%20r%20-%20i)%3B%20%20%2F*%20Insert%20the%20F%20strings%2C%0A%20%20%20%20%20%20%20%20each%20of%20which%20begins%20with%20one%20or%20more%20'space'%20characters.%20%20Note%0A%20%20%20%20%20%20%20%20the%20order%20in%20which%20these%20strings%20are%20inserted.%20%20This%20way%2C%0A%20%20%20%20%20%20%20%20degenerate%20trees%20will%20be%20less%20likely%20to%20occur.%20*%2F%0A%20%20%20%20InsertNode(text_buf%2C%20lson%2C%20rson%2C%20dad%2C%20r)%3B%20%20%2F*%20Finally%2C%20insert%20the%20whole%20string%20just%20read.%20%20The%0A%20%20%20%20%20%20%20%20global%20variables%20match_length%20and%20match_position%20are%20set.%20*%2F%0A%20%20%20%20do%20%7B%0A%20%20%20%20%20%20%20%20if%20(match_length%20%3E%20len)%20match_length%20%3D%20len%3B%20%20%2F*%20match_length%0A%20%20%20%20%20%20%20%20%20%20%20%20may%20be%20spuriously%20long%20near%20the%20end%20of%20text.%20*%2F%0A%20%20%20%20%20%20%20%20if%20(match_length%20%3C%3D%20THRESHOLD)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20match_length%20%3D%201%3B%20%20%2F*%20Not%20long%20enough%20match.%20%20Send%20one%20byte.%20*%2F%0A%20%20%20%20%20%20%20%20%20%20%20%20code_buf%5B0%5D%20%7C%3D%20mask%3B%20%20%2F*%20'send%20one%20byte'%20flag%20*%2F%0A%20%20%20%20%20%20%20%20%20%20%20%20code_buf%5Bcode_buf_ptr%2B%2B%5D%20%3D%20text_buf%5Br%5D%3B%20%20%2F*%20Send%20uncoded.%20*%2F%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20code_buf%5Bcode_buf_ptr%2B%2B%5D%20%3D%20(unsigned%20char)%20match_position%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20code_buf%5Bcode_buf_ptr%2B%2B%5D%20%3D%20(unsigned%20char)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20(((match_position%20%3E%3E%204)%20%26%200xf0)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20(match_length%20-%20(THRESHOLD%20%2B%201)))%3B%20%20%2F*%20Send%20position%20and%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20length%20pair.%20Note%20match_length%20%3E%20THRESHOLD.%20*%2F%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20if%20((mask%20%3C%3C%3D%201)%20%3D%3D%200)%20%7B%20%20%2F*%20Shift%20mask%20left%20one%20bit.%20*%2F%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(i%20%3D%200%3B%20i%20%3C%20code_buf_ptr%3B%20i%2B%2B)%20%7B%20%20%2F*%20Send%20at%20most%208%20units%20of%20*%2F%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_put(code_buf%5Bi%5D)%3B%20%20%20%20%2F*%20code%20together%20*%2F%0A%09%09%09%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20codesize%20%2B%3D%20code_buf_ptr%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20code_buf%5B0%5D%20%3D%200%3B%20%20code_buf_ptr%20%3D%20mask%20%3D%201%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20last_match_length%20%3D%20match_length%3B%0A%20%20%20%20%20%20%20%20for%20(i%20%3D%200%3B%20i%20%3C%20last_match_length%20%26%26%20ilen%3B%20i%2B%2B)%20%7B%0A%09%09%09_get(c)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20DeleteNode(lson%2C%20rson%2C%20dad%2C%20s)%3B%20%20%20%20%20%20%20%20%2F*%20Delete%20old%20strings%20and%20*%2F%0A%20%20%20%20%20%20%20%20%20%20%20%20text_buf%5Bs%5D%20%3D%20c%3B%20%20%20%20%2F*%20read%20new%20bytes%20*%2F%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(s%20%3C%20F%20-%201)%20text_buf%5Bs%20%2B%20N%5D%20%3D%20c%3B%20%20%2F*%20If%20the%20position%20is%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20near%20the%20end%20of%20buffer%2C%20extend%20the%20buffer%20to%20make%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20string%20comparison%20easier.%20*%2F%0A%20%20%20%20%20%20%20%20%20%20%20%20s%20%3D%20(s%20%2B%201)%20%26%20(N%20-%201)%3B%20%20r%20%3D%20(r%20%2B%201)%20%26%20(N%20-%201)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F*%20Since%20this%20is%20a%20ring%20buffer%2C%20increment%20the%20position%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20modulo%20N.%20*%2F%0A%20%20%20%20%20%20%20%20%20%20%20%20InsertNode(text_buf%2C%20lson%2C%20rson%2C%20dad%2C%20r)%3B%20%20%20%20%2F*%20Register%20the%20string%20in%20text_buf%5Br..r%2BF-1%5D%20*%2F%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20while%20(i%2B%2B%20%3C%20last_match_length)%20%7B%20%20%20%20%2F*%20After%20the%20end%20of%20text%2C%20*%2F%0A%20%20%20%20%20%20%20%20%20%20%20%20DeleteNode(lson%2C%20rson%2C%20dad%2C%20s)%3B%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F*%20no%20need%20to%20read%2C%20but%20*%2F%0A%20%20%20%20%20%20%20%20%20%20%20%20s%20%3D%20(s%20%2B%201)%20%26%20(N%20-%201)%3B%20%20r%20%3D%20(r%20%2B%201)%20%26%20(N%20-%201)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(--len)%20InsertNode(text_buf%2C%20lson%2C%20rson%2C%20dad%2C%20r)%3B%20%20%20%20%20%20%20%20%2F*%20buffer%20may%20not%20be%20empty.%20*%2F%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20while%20(len%20%3E%200)%3B%20%20%20%20%2F*%20until%20length%20of%20string%20to%20be%20processed%20is%20zero%20*%2F%0A%20%20%20%20if%20(code_buf_ptr%20%3E%201)%20%7B%20%20%20%20%20%20%20%20%2F*%20Send%20remaining%20code.%20*%2F%0A%20%20%20%20%20%20%20%20for%20(i%20%3D%200%3B%20i%20%3C%20code_buf_ptr%3B%20i%2B%2B)%20%7B%0A%09%09%09_put(code_buf%5Bi%5D)%3B%0A%09%09%7D%0A%20%20%20%20%20%20%20%20codesize%20%2B%3D%20code_buf_ptr%3B%0A%20%20%20%20%7D%0A%0A%09return%20codesize%3B%0A%7D%0A%0Avoid%20Decode(size_t%20ilen%2C%20unsigned%20char*%20istr%2C%20size_t%20olen%2C%20char*%20ostr)%20%20%20%20%2F*%20Just%20the%20reverse%20of%20Encode().%20*%2F%0A%7B%0A%09unsigned%20char%20text_buf%5BN%20%2B%20F%20-%201%5D%3B%20%20%20%20%20%20%20%20%20%20%2F*%20ring%20buffer%20of%20size%20N%2C%20with%20extra%20F-1%20bytes%20to%20facilitate%20string%20comparison%20*%2F%0A%20%20%20%20int%20%20i%2C%20j%2C%20k%2C%20r%2C%20c%3B%0A%20%20%20%20unsigned%20int%20%20flags%3B%0A%20%20%20%20%0A%20%20%20%20for%20(i%20%3D%200%3B%20i%20%3C%20N%20-%20F%3B%20i%2B%2B)%20text_buf%5Bi%5D%20%3D%200%3B%0A%20%20%20%20r%20%3D%20N%20-%20F%3B%20%20flags%20%3D%200%3B%0A%20%20%20%20for%20(%20%3B%20%3B%20)%20%7B%0A%20%20%20%20%20%20%20%20if%20(((flags%20%3E%3E%3D%201)%20%26%20256)%20%3D%3D%200)%20%7B%0A%09%09%09_get(c)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20flags%20%3D%20c%20%7C%200xff00%3B%20%20%20%20%20%20%20%20%2F*%20uses%20higher%20byte%20cleverly%20*%2F%0A%20%20%20%20%20%20%20%20%7D%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F*%20to%20count%20eight%20*%2F%0A%20%20%20%20%20%20%20%20if%20(flags%20%26%201)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20_get(c)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20_put(c)%3B%20%20text_buf%5Br%2B%2B%5D%20%3D%20c%3B%20%20r%20%26%3D%20(N%20-%201)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20_get(i)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20_get(j)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20i%20%7C%3D%20((j%20%26%200xf0)%20%3C%3C%204)%3B%20%20j%20%3D%20(j%20%26%200x0f)%20%2B%20THRESHOLD%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(k%20%3D%200%3B%20k%20%3C%3D%20j%3B%20k%2B%2B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20c%20%3D%20text_buf%5B(i%20%2B%20k)%20%26%20(N%20-%201)%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_put(c)%3B%20%20text_buf%5Br%2B%2B%5D%20%3D%20c%3B%20%20r%20%26%3D%20(N%20-%201)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%7D%0A%0A%23undef%20_get%0A%23undef%20_put" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer">&nbsp;<a href="javascript:void()" title="收藏这段代码" onclick="code_favorites_do_favorite(this);return false;" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer"><img class="star" src="assets/1571226038-bf632ec55a05f69a9359f73417402b26.png" alt="收藏代码"><img class="spinner" src="assets/1571226038-a42df3a5b569bdc98ca473a4a3adfeac.gif" style="display:none"></a></div></div><ol start="1" class="dp-cpp"><li><span><span class="comment">/**************************************************************</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;LZSS.C&nbsp;--&nbsp;A&nbsp;Data&nbsp;Compression&nbsp;Program</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;(tab&nbsp;=&nbsp;4&nbsp;spaces)</span>&nbsp;</span></li><li><span><span class="comment">***************************************************************</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;4/6/1989&nbsp;Haruhiko&nbsp;Okumura</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;Use,&nbsp;distribute,&nbsp;and&nbsp;modify&nbsp;this&nbsp;program&nbsp;freely.</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;Please&nbsp;send&nbsp;me&nbsp;your&nbsp;improved&nbsp;versions.</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PC-VAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SCIENCE</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NIFTY-Serve&nbsp;&nbsp;&nbsp;&nbsp;PAF01022</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CompuServe&nbsp;&nbsp;&nbsp;&nbsp;74050,1022</span>&nbsp;</span></li><li><span><span class="comment">**************************************************************/</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="preprocessor">#include&nbsp;&lt;stdlib.h&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="preprocessor">#include&nbsp;&lt;stdio.h&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="preprocessor">#include&nbsp;&lt;string.h&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="preprocessor">#include&nbsp;&lt;ctype.h&gt;</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="preprocessor">#define&nbsp;N&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4096&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;size&nbsp;of&nbsp;ring&nbsp;buffer&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="preprocessor">#define&nbsp;F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;18&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;upper&nbsp;limit&nbsp;for&nbsp;match_length&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="preprocessor">#define&nbsp;THRESHOLD&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;encode&nbsp;string&nbsp;into&nbsp;position&nbsp;and&nbsp;length&nbsp;if&nbsp;match_length&nbsp;is&nbsp;greater&nbsp;than&nbsp;this&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="preprocessor">#define&nbsp;NIL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;index&nbsp;for&nbsp;root&nbsp;of&nbsp;binary&nbsp;search&nbsp;trees&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="comment">/*&nbsp;of&nbsp;longest&nbsp;match.&nbsp;&nbsp;These&nbsp;are&nbsp;set&nbsp;by&nbsp;the&nbsp;InsertNode()&nbsp;procedure.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">static</span><span>&nbsp;</span><span class="datatypes">int</span><span>&nbsp;match_position;&nbsp;&nbsp;</span></span></li><li><span><span class="keyword">static</span><span>&nbsp;</span><span class="datatypes">int</span><span>&nbsp;match_length;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="keyword">static</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;InsertNode(unsigned&nbsp;</span><span class="datatypes">char</span><span>*&nbsp;text_buf,&nbsp;</span><span class="datatypes">int</span><span>*&nbsp;lson,&nbsp;</span><span class="datatypes">int</span><span>*&nbsp;rson,&nbsp;</span><span class="datatypes">int</span><span>*&nbsp;dad,&nbsp;</span><span class="datatypes">int</span><span>&nbsp;r)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;Inserts&nbsp;string&nbsp;of&nbsp;length&nbsp;F,&nbsp;text_buf[r..r+F-1],&nbsp;into&nbsp;one&nbsp;of&nbsp;the</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trees&nbsp;(text_buf[r]'th&nbsp;tree)&nbsp;and&nbsp;returns&nbsp;the&nbsp;longest-match&nbsp;position</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;length&nbsp;via&nbsp;the&nbsp;global&nbsp;variables&nbsp;match_position&nbsp;and&nbsp;match_length.</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;match_length&nbsp;=&nbsp;F,&nbsp;then&nbsp;removes&nbsp;the&nbsp;old&nbsp;node&nbsp;in&nbsp;favor&nbsp;of&nbsp;the&nbsp;new</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;one,&nbsp;because&nbsp;the&nbsp;old&nbsp;one&nbsp;will&nbsp;be&nbsp;deleted&nbsp;sooner.</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Note&nbsp;r&nbsp;plays&nbsp;double&nbsp;role,&nbsp;as&nbsp;tree&nbsp;node&nbsp;and&nbsp;position&nbsp;in&nbsp;buffer.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">int</span><span>&nbsp;&nbsp;i,&nbsp;p,&nbsp;cmp;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;<span class="datatypes">char</span><span>&nbsp;&nbsp;*key;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;=&nbsp;1;&nbsp;&nbsp;key&nbsp;=&nbsp;&amp;text_buf[r];&nbsp;&nbsp;p&nbsp;=&nbsp;N&nbsp;+&nbsp;1&nbsp;+&nbsp;key[0];&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;rson[r]&nbsp;=&nbsp;lson[r]&nbsp;=&nbsp;NIL;&nbsp;&nbsp;match_length&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(&nbsp;;&nbsp;;&nbsp;)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(cmp&nbsp;&gt;=&nbsp;0)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(rson[p]&nbsp;!=&nbsp;NIL)&nbsp;p&nbsp;=&nbsp;rson[p];&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;{&nbsp;&nbsp;rson[p]&nbsp;=&nbsp;r;&nbsp;&nbsp;dad[r]&nbsp;=&nbsp;p;&nbsp;&nbsp;</span><span class="keyword">return</span><span>;&nbsp;&nbsp;}&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">else</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(lson[p]&nbsp;!=&nbsp;NIL)&nbsp;p&nbsp;=&nbsp;lson[p];&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;{&nbsp;&nbsp;lson[p]&nbsp;=&nbsp;r;&nbsp;&nbsp;dad[r]&nbsp;=&nbsp;p;&nbsp;&nbsp;</span><span class="keyword">return</span><span>;&nbsp;&nbsp;}&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(i&nbsp;=&nbsp;1;&nbsp;i&nbsp;&lt;&nbsp;F;&nbsp;i++)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;((cmp&nbsp;=&nbsp;key[i]&nbsp;-&nbsp;text_buf[p&nbsp;+&nbsp;i])&nbsp;!=&nbsp;0)&nbsp;&nbsp;</span><span class="keyword">break</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(i&nbsp;&gt;&nbsp;match_length)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_position&nbsp;=&nbsp;p;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;((match_length&nbsp;=&nbsp;i)&nbsp;&gt;=&nbsp;F)&nbsp;&nbsp;</span><span class="keyword">break</span><span>;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;dad[r]&nbsp;=&nbsp;dad[p];&nbsp;&nbsp;lson[r]&nbsp;=&nbsp;lson[p];&nbsp;&nbsp;rson[r]&nbsp;=&nbsp;rson[p];&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;dad[lson[p]]&nbsp;=&nbsp;r;&nbsp;&nbsp;dad[rson[p]]&nbsp;=&nbsp;r;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(rson[dad[p]]&nbsp;==&nbsp;p)&nbsp;rson[dad[p]]&nbsp;=&nbsp;r;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lson[dad[p]]&nbsp;=&nbsp;r;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;dad[p]&nbsp;=&nbsp;NIL;&nbsp;&nbsp;<span class="comment">/*&nbsp;remove&nbsp;p&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="keyword">static</span><span>&nbsp;</span><span class="keyword">void</span><span>&nbsp;DeleteNode(</span><span class="datatypes">int</span><span>*&nbsp;lson,&nbsp;</span><span class="datatypes">int</span><span>*&nbsp;rson,&nbsp;</span><span class="datatypes">int</span><span>*&nbsp;dad,&nbsp;</span><span class="datatypes">int</span><span>&nbsp;p)&nbsp;&nbsp;</span><span class="comment">/*&nbsp;deletes&nbsp;node&nbsp;p&nbsp;from&nbsp;tree&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">int</span><span>&nbsp;&nbsp;q;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(dad[p]&nbsp;==&nbsp;NIL)&nbsp;</span><span class="keyword">return</span><span>;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;not&nbsp;in&nbsp;tree&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(rson[p]&nbsp;==&nbsp;NIL)&nbsp;q&nbsp;=&nbsp;lson[p];&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;</span><span class="keyword">if</span><span>&nbsp;(lson[p]&nbsp;==&nbsp;NIL)&nbsp;q&nbsp;=&nbsp;rson[p];&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q&nbsp;=&nbsp;lson[p];&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(rson[q]&nbsp;!=&nbsp;NIL)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">do</span><span>&nbsp;{&nbsp;&nbsp;q&nbsp;=&nbsp;rson[q];&nbsp;&nbsp;}&nbsp;</span><span class="keyword">while</span><span>&nbsp;(rson[q]&nbsp;!=&nbsp;NIL);&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rson[dad[q]]&nbsp;=&nbsp;lson[q];&nbsp;&nbsp;dad[lson[q]]&nbsp;=&nbsp;dad[q];&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lson[q]&nbsp;=&nbsp;lson[p];&nbsp;&nbsp;dad[lson[p]]&nbsp;=&nbsp;q;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rson[q]&nbsp;=&nbsp;rson[p];&nbsp;&nbsp;dad[rson[p]]&nbsp;=&nbsp;q;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;dad[q]&nbsp;=&nbsp;dad[p];&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(rson[dad[p]]&nbsp;==&nbsp;p)&nbsp;rson[dad[p]]&nbsp;=&nbsp;q;&nbsp;&nbsp;</span><span class="keyword">else</span><span>&nbsp;lson[dad[p]]&nbsp;=&nbsp;q;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;dad[p]&nbsp;=&nbsp;NIL;&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="preprocessor">#define&nbsp;_get(c)&nbsp;\</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(!&nbsp;ilen)&nbsp;{\&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;EOF;\&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">break</span><span>;\&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}\&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;*istr;\&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;++istr;\&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;--ilen&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="preprocessor">#define&nbsp;_put(c)&nbsp;\</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;*ostr&nbsp;=&nbsp;c;\&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;++ostr;\&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;--olen&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="datatypes">size_t</span><span>&nbsp;Encode(</span><span class="datatypes">size_t</span><span>&nbsp;ilen,&nbsp;</span><span class="datatypes">char</span><span>*&nbsp;istr,&nbsp;</span><span class="datatypes">size_t</span><span>&nbsp;olen,&nbsp;</span><span class="datatypes">char</span><span>*&nbsp;ostr)&nbsp;&nbsp;</span></span></li><li><span>{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">int</span><span>&nbsp;&nbsp;i,&nbsp;c,&nbsp;len,&nbsp;r,&nbsp;s,&nbsp;last_match_length,&nbsp;code_buf_ptr;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;<span class="datatypes">char</span><span>&nbsp;&nbsp;code_buf[17],&nbsp;mask;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">size_t</span><span>&nbsp;codesize&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">int</span><span>&nbsp;lson[N&nbsp;+&nbsp;1],&nbsp;rson[N&nbsp;+&nbsp;257],&nbsp;dad[N&nbsp;+&nbsp;1];&nbsp;</span><span class="comment">/*&nbsp;left&nbsp;&amp;&nbsp;right&nbsp;children&nbsp;&amp;&nbsp;parents&nbsp;--&nbsp;These&nbsp;constitute&nbsp;binary&nbsp;search&nbsp;trees.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;<span class="datatypes">char</span><span>&nbsp;text_buf[N&nbsp;+&nbsp;F&nbsp;-&nbsp;1];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;ring&nbsp;buffer&nbsp;of&nbsp;size&nbsp;N,&nbsp;with&nbsp;extra&nbsp;F-1&nbsp;bytes&nbsp;to&nbsp;facilitate&nbsp;string&nbsp;comparison&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;match_position&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;match_length&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(ilen&nbsp;==&nbsp;0)&nbsp;</span><span class="keyword">return</span><span>&nbsp;0;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;initialize&nbsp;trees&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;For&nbsp;i&nbsp;=&nbsp;0&nbsp;to&nbsp;N&nbsp;-&nbsp;1,&nbsp;rson[i]&nbsp;and&nbsp;lson[i]&nbsp;will&nbsp;be&nbsp;the&nbsp;right&nbsp;and</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;left&nbsp;children&nbsp;of&nbsp;node&nbsp;i.&nbsp;&nbsp;These&nbsp;nodes&nbsp;need&nbsp;not&nbsp;be&nbsp;initialized.</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;Also,&nbsp;dad[i]&nbsp;is&nbsp;the&nbsp;parent&nbsp;of&nbsp;node&nbsp;i.&nbsp;&nbsp;These&nbsp;are&nbsp;initialized&nbsp;to</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;NIL&nbsp;(=&nbsp;N),&nbsp;which&nbsp;stands&nbsp;for&nbsp;'not&nbsp;used.'</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;For&nbsp;i&nbsp;=&nbsp;0&nbsp;to&nbsp;255,&nbsp;rson[N&nbsp;+&nbsp;i&nbsp;+&nbsp;1]&nbsp;is&nbsp;the&nbsp;root&nbsp;of&nbsp;the&nbsp;tree</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;strings&nbsp;that&nbsp;begin&nbsp;with&nbsp;character&nbsp;i.&nbsp;&nbsp;These&nbsp;are&nbsp;initialized</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;NIL.&nbsp;&nbsp;Note&nbsp;there&nbsp;are&nbsp;256&nbsp;trees.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(i&nbsp;=&nbsp;N&nbsp;+&nbsp;1;&nbsp;i&nbsp;&lt;=&nbsp;N&nbsp;+&nbsp;256;&nbsp;i++)&nbsp;rson[i]&nbsp;=&nbsp;NIL;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;N;&nbsp;i++)&nbsp;dad[i]&nbsp;=&nbsp;NIL;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;code_buf[0]&nbsp;=&nbsp;0;&nbsp;&nbsp;<span class="comment">/*&nbsp;code_buf[1..16]&nbsp;saves&nbsp;eight&nbsp;units&nbsp;of&nbsp;code,&nbsp;and</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code_buf[0]&nbsp;works&nbsp;as&nbsp;eight&nbsp;flags,&nbsp;"1"&nbsp;representing&nbsp;that&nbsp;the&nbsp;unit</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;an&nbsp;unencoded&nbsp;letter&nbsp;(1&nbsp;byte),&nbsp;"0"&nbsp;a&nbsp;position-and-length&nbsp;pair</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(2&nbsp;bytes).&nbsp;&nbsp;Thus,&nbsp;eight&nbsp;units&nbsp;require&nbsp;at&nbsp;most&nbsp;16&nbsp;bytes&nbsp;of&nbsp;code.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;code_buf_ptr&nbsp;=&nbsp;mask&nbsp;=&nbsp;1;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;0;&nbsp;&nbsp;r&nbsp;=&nbsp;N&nbsp;-&nbsp;F;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(i&nbsp;=&nbsp;s;&nbsp;i&nbsp;&lt;&nbsp;r;&nbsp;i++)&nbsp;text_buf[i]&nbsp;=&nbsp;0;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;Clear&nbsp;the&nbsp;buffer&nbsp;with</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;any&nbsp;character&nbsp;that&nbsp;will&nbsp;appear&nbsp;often.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(len&nbsp;=&nbsp;0;&nbsp;len&nbsp;&lt;&nbsp;F&nbsp;&amp;&amp;&nbsp;ilen;&nbsp;len++)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_get(c);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text_buf[r&nbsp;+&nbsp;len]&nbsp;=&nbsp;c;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;Read&nbsp;F&nbsp;bytes&nbsp;into&nbsp;the&nbsp;last&nbsp;F&nbsp;bytes&nbsp;of&nbsp;the&nbsp;buffer&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(i&nbsp;=&nbsp;1;&nbsp;i&nbsp;&lt;=&nbsp;F;&nbsp;i++)&nbsp;InsertNode(text_buf,&nbsp;lson,&nbsp;rson,&nbsp;dad,&nbsp;r&nbsp;-&nbsp;i);&nbsp;&nbsp;</span><span class="comment">/*&nbsp;Insert&nbsp;the&nbsp;F&nbsp;strings,</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;each&nbsp;of&nbsp;which&nbsp;begins&nbsp;with&nbsp;one&nbsp;or&nbsp;more&nbsp;'space'&nbsp;characters.&nbsp;&nbsp;Note</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;order&nbsp;in&nbsp;which&nbsp;these&nbsp;strings&nbsp;are&nbsp;inserted.&nbsp;&nbsp;This&nbsp;way,</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;degenerate&nbsp;trees&nbsp;will&nbsp;be&nbsp;less&nbsp;likely&nbsp;to&nbsp;occur.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;InsertNode(text_buf,&nbsp;lson,&nbsp;rson,&nbsp;dad,&nbsp;r);&nbsp;&nbsp;<span class="comment">/*&nbsp;Finally,&nbsp;insert&nbsp;the&nbsp;whole&nbsp;string&nbsp;just&nbsp;read.&nbsp;&nbsp;The</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;variables&nbsp;match_length&nbsp;and&nbsp;match_position&nbsp;are&nbsp;set.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">do</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(match_length&nbsp;&gt;&nbsp;len)&nbsp;match_length&nbsp;=&nbsp;len;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;match_length</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;may&nbsp;be&nbsp;spuriously&nbsp;long&nbsp;near&nbsp;the&nbsp;end&nbsp;of&nbsp;text.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(match_length&nbsp;&lt;=&nbsp;THRESHOLD)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match_length&nbsp;=&nbsp;1;&nbsp;&nbsp;<span class="comment">/*&nbsp;Not&nbsp;long&nbsp;enough&nbsp;match.&nbsp;&nbsp;Send&nbsp;one&nbsp;byte.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code_buf[0]&nbsp;|=&nbsp;mask;&nbsp;&nbsp;<span class="comment">/*&nbsp;'send&nbsp;one&nbsp;byte'&nbsp;flag&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code_buf[code_buf_ptr++]&nbsp;=&nbsp;text_buf[r];&nbsp;&nbsp;<span class="comment">/*&nbsp;Send&nbsp;uncoded.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">else</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code_buf[code_buf_ptr++]&nbsp;=&nbsp;(unsigned&nbsp;<span class="datatypes">char</span><span>)&nbsp;match_position;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code_buf[code_buf_ptr++]&nbsp;=&nbsp;(unsigned&nbsp;<span class="datatypes">char</span><span>)&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(((match_position&nbsp;&gt;&gt;&nbsp;4)&nbsp;&amp;&nbsp;0xf0)&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;(match_length&nbsp;-&nbsp;(THRESHOLD&nbsp;+&nbsp;1)));&nbsp;&nbsp;<span class="comment">/*&nbsp;Send&nbsp;position&nbsp;and</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;length&nbsp;pair.&nbsp;Note&nbsp;match_length&nbsp;&gt;&nbsp;THRESHOLD.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;((mask&nbsp;&lt;&lt;=&nbsp;1)&nbsp;==&nbsp;0)&nbsp;{&nbsp;&nbsp;</span><span class="comment">/*&nbsp;Shift&nbsp;mask&nbsp;left&nbsp;one&nbsp;bit.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;code_buf_ptr;&nbsp;i++)&nbsp;{&nbsp;&nbsp;</span><span class="comment">/*&nbsp;Send&nbsp;at&nbsp;most&nbsp;8&nbsp;units&nbsp;of&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_put(code_buf[i]);&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;code&nbsp;together&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codesize&nbsp;+=&nbsp;code_buf_ptr;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code_buf[0]&nbsp;=&nbsp;0;&nbsp;&nbsp;code_buf_ptr&nbsp;=&nbsp;mask&nbsp;=&nbsp;1;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;last_match_length&nbsp;=&nbsp;match_length;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;last_match_length&nbsp;&amp;&amp;&nbsp;ilen;&nbsp;i++)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_get(c);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeleteNode(lson,&nbsp;rson,&nbsp;dad,&nbsp;s);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;Delete&nbsp;old&nbsp;strings&nbsp;and&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text_buf[s]&nbsp;=&nbsp;c;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;read&nbsp;new&nbsp;bytes&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(s&nbsp;&lt;&nbsp;F&nbsp;-&nbsp;1)&nbsp;text_buf[s&nbsp;+&nbsp;N]&nbsp;=&nbsp;c;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;If&nbsp;the&nbsp;position&nbsp;is</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;near&nbsp;the&nbsp;end&nbsp;of&nbsp;buffer,&nbsp;extend&nbsp;the&nbsp;buffer&nbsp;to&nbsp;make</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;comparison&nbsp;easier.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;(s&nbsp;+&nbsp;1)&nbsp;&amp;&nbsp;(N&nbsp;-&nbsp;1);&nbsp;&nbsp;r&nbsp;=&nbsp;(r&nbsp;+&nbsp;1)&nbsp;&amp;&nbsp;(N&nbsp;-&nbsp;1);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;Since&nbsp;this&nbsp;is&nbsp;a&nbsp;ring&nbsp;buffer,&nbsp;increment&nbsp;the&nbsp;position</span>&nbsp;</span></li><li><span><span class="comment">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modulo&nbsp;N.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InsertNode(text_buf,&nbsp;lson,&nbsp;rson,&nbsp;dad,&nbsp;r);&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;Register&nbsp;the&nbsp;string&nbsp;in&nbsp;text_buf[r..r+F-1]&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span><span>&nbsp;(i++&nbsp;&lt;&nbsp;last_match_length)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;After&nbsp;the&nbsp;end&nbsp;of&nbsp;text,&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeleteNode(lson,&nbsp;rson,&nbsp;dad,&nbsp;s);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;no&nbsp;need&nbsp;to&nbsp;read,&nbsp;but&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;(s&nbsp;+&nbsp;1)&nbsp;&amp;&nbsp;(N&nbsp;-&nbsp;1);&nbsp;&nbsp;r&nbsp;=&nbsp;(r&nbsp;+&nbsp;1)&nbsp;&amp;&nbsp;(N&nbsp;-&nbsp;1);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(--len)&nbsp;InsertNode(text_buf,&nbsp;lson,&nbsp;rson,&nbsp;dad,&nbsp;r);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;buffer&nbsp;may&nbsp;not&nbsp;be&nbsp;empty.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">while</span><span>&nbsp;(len&nbsp;&gt;&nbsp;0);&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;until&nbsp;length&nbsp;of&nbsp;string&nbsp;to&nbsp;be&nbsp;processed&nbsp;is&nbsp;zero&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(code_buf_ptr&nbsp;&gt;&nbsp;1)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;Send&nbsp;remaining&nbsp;code.&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;code_buf_ptr;&nbsp;i++)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_put(code_buf[i]);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;codesize&nbsp;+=&nbsp;code_buf_ptr;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;codesize;&nbsp;&nbsp;</span></span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="keyword">void</span><span>&nbsp;Decode(</span><span class="datatypes">size_t</span><span>&nbsp;ilen,&nbsp;unsigned&nbsp;</span><span class="datatypes">char</span><span>*&nbsp;istr,&nbsp;</span><span class="datatypes">size_t</span><span>&nbsp;olen,&nbsp;</span><span class="datatypes">char</span><span>*&nbsp;ostr)&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;Just&nbsp;the&nbsp;reverse&nbsp;of&nbsp;Encode().&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>{&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;<span class="datatypes">char</span><span>&nbsp;text_buf[N&nbsp;+&nbsp;F&nbsp;-&nbsp;1];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="comment">/*&nbsp;ring&nbsp;buffer&nbsp;of&nbsp;size&nbsp;N,&nbsp;with&nbsp;extra&nbsp;F-1&nbsp;bytes&nbsp;to&nbsp;facilitate&nbsp;string&nbsp;comparison&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">int</span><span>&nbsp;&nbsp;i,&nbsp;j,&nbsp;k,&nbsp;r,&nbsp;c;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;<span class="datatypes">int</span><span>&nbsp;&nbsp;flags;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;N&nbsp;-&nbsp;F;&nbsp;i++)&nbsp;text_buf[i]&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;r&nbsp;=&nbsp;N&nbsp;-&nbsp;F;&nbsp;&nbsp;flags&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(&nbsp;;&nbsp;;&nbsp;)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(((flags&nbsp;&gt;&gt;=&nbsp;1)&nbsp;&amp;&nbsp;256)&nbsp;==&nbsp;0)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_get(c);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flags&nbsp;=&nbsp;c&nbsp;|&nbsp;0xff00;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;uses&nbsp;higher&nbsp;byte&nbsp;cleverly&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*&nbsp;to&nbsp;count&nbsp;eight&nbsp;*/</span><span>&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;(flags&nbsp;&amp;&nbsp;1)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_get(c);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_put(c);&nbsp;&nbsp;text_buf[r++]&nbsp;=&nbsp;c;&nbsp;&nbsp;r&nbsp;&amp;=&nbsp;(N&nbsp;-&nbsp;1);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">else</span><span>&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_get(i);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_get(j);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i&nbsp;|=&nbsp;((j&nbsp;&amp;&nbsp;0xf0)&nbsp;&lt;&lt;&nbsp;4);&nbsp;&nbsp;j&nbsp;=&nbsp;(j&nbsp;&amp;&nbsp;0x0f)&nbsp;+&nbsp;THRESHOLD;&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span><span>&nbsp;(k&nbsp;=&nbsp;0;&nbsp;k&nbsp;&lt;=&nbsp;j;&nbsp;k++)&nbsp;{&nbsp;&nbsp;</span></span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;text_buf[(i&nbsp;+&nbsp;k)&nbsp;&amp;&nbsp;(N&nbsp;-&nbsp;1)];&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_put(c);&nbsp;&nbsp;text_buf[r++]&nbsp;=&nbsp;c;&nbsp;&nbsp;r&nbsp;&amp;=&nbsp;(N&nbsp;-&nbsp;1);&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span></li><li><span>}&nbsp;&nbsp;</span></li><li><span>&nbsp;&nbsp;</span></li><li><span><span class="preprocessor">#undef&nbsp;_get</span><span>&nbsp;&nbsp;</span></span></li><li><span><span class="preprocessor">#undef&nbsp;_put</span><span>&nbsp;&nbsp;</span></span></li></ol></div>
<br>
<br>最后把需要的Ruby和那归档处理程序打个包放附件。备份完成 XDD

  
  <div class="attachments">
    
      
        <ul>
          <li><a href="http://dl.iteye.com/topics/download/736e6aff-683b-3356-affe-a1e50ebd1434" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">bmw_archiver.zip</a> (3.9 MB)</li>
          
          <li>下载次数: 10</li>
        </ul>
      
    
    
  </div>



  <div id="bottoms" class="clearfix">
    
    <div id="share_weibo">分享到：
      <a data-type="sina" href="javascript:;" title="分享到新浪微博" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer"><img src="assets/1571226038-18e900b8666ce6f233d25ec02f95ee59.jpg"></a>
      <a data-type="qq" href="javascript:;" title="分享到腾讯微博" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer"><img src="assets/1571226038-72dd548719f0ace4d5f9bca64e1d7715.jpg"></a>
    </div>
  </div>

  <div class="blog_nav">
    <div class="pre_next">
      <a href="https://www.iteye.com/blog/659108" class="next" title="HotSpot 17.0-b12的逃逸分析/标量替换的一个演示" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">HotSpot 17.0-b12的逃逸分析/标量替换的一 ...</a>
      |
      <a href="https://www.iteye.com/blog/656951" class="pre" title="关于Java程序的执行的一次分享" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">关于Java程序的执行的一次分享</a>
    </div>
  </div>
  <div class="blog_bottom">
    <ul>
      <li>2010-05-03 21:40</li>
      <li>浏览 1836</li>
      <li><a href="#comments">评论(8)</a></li>
      
      
      <li>分类:<a href="https://www.iteye.com/blogs/category/other" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">非技术</a></li>      
      <li class="last"><a href="https://www.iteye.com/wiki/blog/658308" target="_blank" class="more" referrerpolicy="no-referrer" rel="noopener noreferrer">查看更多</a></li>
    </ul>    
  </div>
    
  <div class="blog_comment">
    <h5>评论</h5>
    <a id="comments" name="comments" data-mx-warn="Empty URL"></a>
    <div id="bc1486470">
  <div class="comment_title">
    8 楼
    <a href="https://www.iteye.com/blog/user/night-stalker-deleted" target="_blank" title="night_stalker" referrerpolicy="no-referrer" rel="noopener noreferrer">night_stalker</a>
    2010-05-08&nbsp;&nbsp;
    
    
  </div>
  <div class="comment_content">唔，原来 github 可以加多个 ssh key，终于可以把代码扔上去了 ……<br><a rel="noopener noreferrer" target="_blank" href="http://github.com/luikore/lzss" referrerpolicy="no-referrer">http://github.com/luikore/lzss</a></div>
</div>

<div id="bc1481336">
  <div class="comment_title">
    7 楼
    <a href="https://www.iteye.com/blog/user/rednaxelafx" target="_blank" title="RednaxelaFX" referrerpolicy="no-referrer" rel="noopener noreferrer">RednaxelaFX</a>
    2010-05-04&nbsp;&nbsp;
    
    
  </div>
  <div class="comment_content"><div class="quote_title">Sword-Breaker 写道</div><div class="quote_div">咦,我一直以为只有ppg和sosg的在做...(当年在ppg论坛看到的补丁,貌似是sosg+ppg的),补丁出来的话请务必在推特上说一句(我FO你了=,=)...以前订你的blog都是为了技术文=,=没想到突然跑个BMW银的文章出来=,=</div><br>咳咳，这边就是PPG组……而且这篇也勉强算是技术文吧orz<br>有兴趣的话可以看一下左边栏里reverse engineering类里面的东西 &gt;_&lt;<br><br>哈哈，想当年还有宝马撞车事件，然后多交了几个碰友 XDD</div>
</div>

<div id="bc1481327">
  <div class="comment_title">
    6 楼
    <a href="https://www.iteye.com/blog/user/sword-breaker" target="_blank" title="Sword-Breaker" referrerpolicy="no-referrer" rel="noopener noreferrer">Sword-Breaker</a>
    2010-05-04&nbsp;&nbsp;
    
    
  </div>
  <div class="comment_content"><div class="quote_title">RednaxelaFX 写道</div><div class="quote_div"><div class="quote_title">Sword-Breaker 写道</div><div class="quote_div">无意中发现关于BMW银的汉化信息=,=搜了一下发现sosg在去年11月就有一个补丁,不过似乎是一个有bug而且针对先行版的版本...按照你的说法=,=看来很快就有完整版了的汉化补丁了么</div><br>应该……快了吧？我也不太清楚现在进度如何，好久没跟大家联系过了。<br>茶茶一直在催我写这玩儿，说再不写就直接不打成DAT包发掉。<br>年初我也已经把改过的exe给了，应该就剩打包了吧？<br><br>Umm，这边不是SOSG。<br>我都不记得我们这组的BMW汉化最初是针对BMW2还是BMW3做的了，发也已经发过好几版补丁了。好久远啊……终于要完全结束了。</div><br><br>咦,我一直以为只有ppg和sosg的在做...(当年在ppg论坛看到的补丁,貌似是sosg+ppg的),补丁出来的话请务必在推特上说一句(我FO你了=,=)...以前订你的blog都是为了技术文=,=没想到突然跑个BMW银的文章出来=,=</div>
</div>

<div id="bc1481287">
  <div class="comment_title">
    5 楼
    <a href="https://www.iteye.com/blog/user/rednaxelafx" target="_blank" title="RednaxelaFX" referrerpolicy="no-referrer" rel="noopener noreferrer">RednaxelaFX</a>
    2010-05-04&nbsp;&nbsp;
    
    
  </div>
  <div class="comment_content"><div class="quote_title">Sword-Breaker 写道</div><div class="quote_div">无意中发现关于BMW银的汉化信息=,=搜了一下发现sosg在去年11月就有一个补丁,不过似乎是一个有bug而且针对先行版的版本...按照你的说法=,=看来很快就有完整版了的汉化补丁了么</div><br>应该……快了吧？我也不太清楚现在进度如何，好久没跟大家联系过了。<br>茶茶一直在催我写这玩儿，说再不写就直接不打成DAT包发掉。<br>年初我也已经把改过的exe给了，应该就剩打包了吧？<br><br>Umm，这边不是SOSG。<br>我都不记得我们这组的BMW汉化最初是针对BMW2还是BMW3做的了，发也已经发过好几版补丁了。好久远啊……终于要完全结束了。</div>
</div>

<div id="bc1481275">
  <div class="comment_title">
    4 楼
    <a href="https://www.iteye.com/blog/user/sword-breaker" target="_blank" title="Sword-Breaker" referrerpolicy="no-referrer" rel="noopener noreferrer">Sword-Breaker</a>
    2010-05-04&nbsp;&nbsp;
    
    
  </div>
  <div class="comment_content">无意中发现关于BMW银的汉化信息=,=搜了一下发现sosg在去年11月就有一个补丁,不过似乎是一个有bug而且针对先行版的版本...按照你的说法=,=看来很快就有完整版了的汉化补丁了么</div>
</div>

<div id="bc1481105">
  <div class="comment_title">
    3 楼
    <a href="https://www.iteye.com/blog/user/lwwin" target="_blank" title="lwwin" referrerpolicy="no-referrer" rel="noopener noreferrer">lwwin</a>
    2010-05-04&nbsp;&nbsp;
    
    
  </div>
  <div class="comment_content">当然－ －我觉得你可以称作语言不依赖的koder了^^
<br>
<br>然后特化到ruby么= = 好吧……我看不懂 OTL</div>
</div>

<div id="bc1480020">
  <div class="comment_title">
    2 楼
    <a href="https://www.iteye.com/blog/user/rednaxelafx" target="_blank" title="RednaxelaFX" referrerpolicy="no-referrer" rel="noopener noreferrer">RednaxelaFX</a>
    2010-05-03&nbsp;&nbsp;
    
    
  </div>
  <div class="comment_content"><div class="quote_title">lwwin 写道</div><div class="quote_div">无论如何－ －都不用C来写吗－ －|||</div>
<br>不啊以前写的有几个工具是用C或者C++写的。没记错的话ef和恋楯的都是C++写的，还有啥是用C写的来着……忘了。太久没写这种小玩儿了 =_=|||
<br>现在的话写这种东西我是会首选Ruby的，关键是自己写起来舒服就好。</div>
</div>

<div id="bc1480011">
  <div class="comment_title">
    1 楼
    <a href="https://www.iteye.com/blog/user/lwwin" target="_blank" title="lwwin" referrerpolicy="no-referrer" rel="noopener noreferrer">lwwin</a>
    2010-05-03&nbsp;&nbsp;
    
    
  </div>
  <div class="comment_content">无论如何－ －都不用C来写吗－ －|||</div>
</div>


    
    
  </div>

  <div class="blog_comment">
    <h5>发表评论</h5>
            <p style="text-align:center; margin-top:30px;margin-bottom:0px;"><a href="https://www.iteye.com/login" style="background-color: white; --darkreader-inline-bgcolor:#191a1b;" data-darkreader-inline-bgcolor="" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer"> <img src="assets/1571226038-cf6d69dfbb92d2238c3e50c97eb9e7bf.png" style="vertical-align:middle; margin-right: 10px;"></a><a href="https://www.iteye.com/login" target="_blank" referrerpolicy="no-referrer" rel="noopener noreferrer">  您还没有登录,请您登录后再发表评论 </a></p>
      </div>
  </div>
  <div>
    <div style="" id="_4f5645bo3nc"></div>
    <!-- 多条广告如下脚本只需引入一次 -->
    
  </div>
</div>







      </div></DIV></DIV>
        
      </div>
    </body>
  </html>